<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRN â€” Minority Shareholder Buyout Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<style>
:root{--g:#1E6B3C;--gdk:#0F3D22;--gmd:#2E8B57;--glt:#5AAB6E;--gpale:#EAF5EE;--gold:#B8860B;--goldt:#FFF8E7;--red:#B91C1C;--redt:#FEF2F2;--blue:#1D4ED8;--bluet:#EFF6FF;--slate:#475569;--slatet:#F1F5F9;--slatebdr:#CBD5E1;--gray9:#111827;--gray7:#374151;--gray5:#6B7280;--gray3:#D1D5DB;--gray1:#F9FAFB;--bdr:#E5E7EB;--white:#FFFFFF;--sh:280px;--hh:60px;--r:6px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:13px}body{font-family:'Open Sans',sans-serif;background:#F3F4F6;color:var(--gray7);line-height:1.5}
.hdr{position:fixed;top:0;left:0;right:0;z-index:300;height:var(--hh);background:#fff;border-bottom:2px solid var(--g);display:flex;align-items:center;padding:0 20px;gap:14px}
.hdr-logo{display:flex;align-items:center;padding-right:14px;border-right:1px solid var(--bdr);height:100%}
.hdr-logo img{height:36px;width:auto;object-fit:contain}
.hdr-logo-fb{display:none;align-items:center;gap:8px}
.hdr-logo-fb-box{width:36px;height:36px;background:var(--g);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff;flex-shrink:0}
.hdr-logo-fb .ln1{font-size:10px;font-weight:800;color:var(--gdk)}.hdr-logo-fb .ln2{font-size:10px;font-weight:800;color:var(--g)}.hdr-logo-fb .ln3{font-size:7px;color:var(--gray5);letter-spacing:1.5px}
.hdr-titles{flex:1}.hdr-title{font-size:13px;font-weight:700;color:var(--gdk)}.hdr-sub{font-size:10px;color:var(--gray5);margin-top:1px}
.hdr-right{display:flex;align-items:center;gap:8px}
.badge{padding:3px 9px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:.7px;text-transform:uppercase}
.b-conf{background:var(--redt);color:var(--red);border:1px solid #FECACA}.b-sc{background:var(--gpale);color:var(--g);border:1px solid #BBF7D0}.b-date{font-size:10px;color:var(--gray5)}
.layout{display:grid;grid-template-columns:var(--sh) 1fr;padding-top:var(--hh);min-height:100vh}
/* SIDEBAR */
.sb{background:var(--gdk);position:sticky;top:var(--hh);height:calc(100vh - var(--hh));overflow-y:auto;padding:16px 14px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent}
.sb::-webkit-scrollbar{width:3px}.sb::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:2px}
.sb-hdr{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.38);margin-bottom:9px;padding-bottom:5px;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-sec{margin-bottom:20px}
.sc-row{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:8px}
.sc-btn{padding:7px 2px;border-radius:4px;border:1px solid rgba(255,255,255,.12);background:transparent;color:rgba(255,255,255,.4);font-family:'Open Sans',sans-serif;font-size:11px;font-weight:700;cursor:pointer;text-align:center;transition:all .18s}
.sc-btn:hover:not(.act){border-color:rgba(255,255,255,.4);color:rgba(255,255,255,.8)}.sc-btn.act{background:var(--gmd);border-color:var(--glt);color:#fff}
/* FV dropdowns */
.fv-ctrl{margin-bottom:8px}
.fv-ctrl-lbl{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:rgba(255,255,255,.38);margin-bottom:4px}
.fv-sel-wrap{position:relative}
.fv-sel{width:100%;padding:6px 28px 6px 10px;border-radius:4px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.07);color:rgba(255,255,255,.88);font-family:'Open Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;appearance:none;-webkit-appearance:none;outline:none;transition:all .18s}
.fv-sel:hover{border-color:rgba(255,255,255,.3);background:rgba(255,255,255,.11)}
.fv-sel:focus{border-color:var(--glt)}
.fv-sel option{background:#0F3D22;color:#fff}
.fv-sel-wrap::after{content:'â–¾';position:absolute;right:9px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.45);font-size:10px;pointer-events:none}
.fv-price-line{font-size:9.5px;color:rgba(255,255,255,.42);margin-top:4px;padding-left:2px;letter-spacing:.2px}
.fv-price-line b{color:#6EE7B7;font-weight:700}
/* Scenario desc box */
.sc-desc-box{margin-top:8px;padding:8px 10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);border-radius:4px}
.sc-desc{font-size:9.5px;color:rgba(255,255,255,.62);line-height:1.55;margin-bottom:5px}
.sc-stats{display:flex;flex-direction:column;gap:2px}
.sc-stats span{font-size:9px;color:rgba(255,255,255,.38)}
.sc-stats b{color:rgba(255,255,255,.78)}
/* Price sensitivity heatmap in main area */
.psh-tbl{border-collapse:collapse;width:100%;font-size:11px}
.psh-tbl th{background:var(--gdk);color:rgba(255,255,255,.82);padding:6px 8px;text-align:center;font-size:9px;font-weight:700;letter-spacing:.5px;border:1px solid rgba(255,255,255,.08);white-space:nowrap}
.psh-tbl th.rh{text-align:left;background:var(--g);min-width:60px}
.psh-tbl td{padding:3px;border:1px solid rgba(0,0,0,.04);text-align:center}
.psc{display:inline-flex;align-items:center;justify-content:center;border-radius:3px;padding:4px 3px;min-width:56px;font-size:10px;font-weight:700;width:100%;transition:transform .1s;cursor:default}
.psc:hover{transform:scale(1.08);position:relative;z-index:4;box-shadow:0 2px 8px rgba(0,0,0,.18)}
.psc.cur-row{outline:2px solid #F59E0B;outline-offset:-2px}
.psc.cur-cell{box-shadow:0 0 0 2px #B8860B,0 0 8px rgba(184,134,11,.4);position:relative;z-index:5}
.sc-price-tag{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:3px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:10px;color:rgba(255,255,255,.7);margin-top:5px;font-family:'Courier New',monospace}
.sc-price-tag b{color:#FCD34D}
.ctrl{margin-bottom:12px}.ctrl-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.ctrl-lbl{font-size:9.5px;font-weight:600;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px}.ctrl-val{font-size:12px;font-weight:700;color:#F59E0B}
input[type=range]{-webkit-appearance:none;width:100%;height:3px;background:rgba(255,255,255,.14);border-radius:2px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:#F59E0B;border-radius:50%;border:2px solid var(--gdk);cursor:pointer;transition:transform .15s}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2)}
.ctrl-range{display:flex;justify-content:space-between;margin-top:2px}.ctrl-range span{font-size:8px;color:rgba(255,255,255,.22);font-weight:500}
.sb-kpis{display:flex;flex-direction:column;gap:6px}
.sb-kpi{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:4px;padding:8px 10px;display:flex;align-items:center;gap:9px}
.sb-kpi-val{font-size:17px;font-weight:800;color:#fff;line-height:1;min-width:48px}.sb-kpi-meta .lbl{font-size:9px;text-transform:uppercase;letter-spacing:.7px;color:rgba(255,255,255,.38)}.sb-kpi-meta .sub{font-size:9px;color:rgba(255,255,255,.5);margin-top:1px}
.kv-g{color:#6EE7B7}.kv-y{color:#FCD34D}
.opt-wrap{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:4px;padding:10px 12px;margin-top:4px}
.opt-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}.opt-score{font-size:24px;font-weight:800;color:#FCD34D;line-height:1}.opt-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.7px;color:rgba(255,255,255,.38)}
.opt-track{height:5px;background:rgba(255,255,255,.08);border-radius:100px;overflow:hidden}.opt-fill{height:100%;border-radius:100px;transition:width .4s}.opt-note{font-size:9px;color:rgba(255,255,255,.35);margin-top:4px}
.preset-list{display:flex;flex-direction:column;gap:5px}
.preset-btn{padding:7px 10px;border-radius:4px;border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.03);color:rgba(255,255,255,.6);font-family:'Open Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;text-align:left;transition:all .18s}
.preset-btn:hover{background:rgba(255,255,255,.09);color:#fff}.preset-btn.act{background:rgba(30,107,60,.45);border-color:var(--glt);color:#fff}
/* MAIN */
.main{padding:18px 20px;min-height:calc(100vh - var(--hh));min-width:0;overflow-x:hidden}
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:11px;margin-bottom:16px}
.kpi{background:#fff;border-radius:var(--r);padding:15px 15px 12px;border:1px solid var(--bdr);position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.g::before{background:var(--g)}.kpi.y::before{background:var(--gold)}.kpi.r::before{background:var(--red)}.kpi.b::before{background:var(--blue)}.kpi.n::before{background:var(--gray5)}
.kpi-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--gray5);margin-bottom:6px}.kpi-val{font-size:26px;font-weight:800;color:var(--gray9);line-height:1}.kpi-sub{font-size:10px;color:var(--gray5);margin-top:4px}
.kpi-pill{position:absolute;top:11px;right:11px;padding:2px 7px;border-radius:10px;font-size:9.5px;font-weight:700}
.pill-g{background:var(--gpale);color:var(--g)}.pill-y{background:var(--goldt);color:#78590A}.pill-r{background:var(--redt);color:var(--red)}.pill-b{background:var(--bluet);color:var(--blue)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:13px}.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:13px;margin-bottom:13px}
.card{background:#fff;border-radius:var(--r);padding:15px;border:1px solid var(--bdr)}
.card-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--gray7);margin-bottom:2px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-desc{font-size:10px;color:var(--gray5);margin-bottom:11px}
.cbadge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;flex-shrink:0}
.cb-g{background:var(--gpale);color:var(--g)}.cb-y{background:var(--goldt);color:#78590A}.cb-r{background:var(--redt);color:var(--red)}.cb-b{background:var(--bluet);color:var(--blue)}
/* TABS */
.tabs{display:flex;border-bottom:2px solid var(--bdr);margin-bottom:15px}
.tab{padding:8px 15px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;cursor:pointer;border:none;background:none;color:var(--gray5);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .18s;font-family:'Open Sans',sans-serif}
.tab:hover:not(.act){color:var(--g)}.tab.act{color:var(--g);border-bottom-color:var(--g)}
.tp{display:none}.tp.act{display:block}
/* DONUTS */
.donut-row{display:flex;align-items:center;gap:13px}.donut-wrap{position:relative;width:108px;height:108px;flex-shrink:0}
.dl-item{display:flex;align-items:center;gap:7px;margin-bottom:8px}.dl-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}.dl-name{font-size:10px;color:var(--gray7);flex:1}.dl-val{font-size:12px;font-weight:700;color:var(--gray9)}
/* TECHMET */
.tm-big{font-size:40px;font-weight:800;color:var(--g);line-height:1;letter-spacing:-2px}.tm-sub{font-size:10px;color:var(--gray5);margin-top:2px}
.tm-track{height:7px;background:var(--gray1);border-radius:100px;margin:9px 0 7px;overflow:hidden;border:1px solid var(--bdr)}.tm-fill{height:100%;border-radius:100px;background:linear-gradient(90deg,var(--gdk),var(--glt));transition:width .5s}
.tm-2col{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:2px}
.tm-box{padding:8px;border-radius:var(--r);text-align:center}.tm-b0{background:var(--gray1);border:1px solid var(--bdr)}.tm-b1{background:var(--gpale);border:1px solid #BBF7D0}
.tm-num{font-size:15px;font-weight:800}.tm-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.6px;color:var(--gray5);margin-top:2px}.tm-b1 .tm-num{color:var(--g)}
/* HEATMAP */
.heat-wrap{overflow-x:auto;border-radius:var(--r);border:1px solid var(--bdr)}
.ht{border-collapse:collapse;width:100%}.ht th{background:var(--gdk);color:rgba(255,255,255,.8);padding:5px;text-align:center;font-size:9px;font-weight:700;white-space:nowrap;border:1px solid rgba(255,255,255,.07)}.ht th.rh{text-align:left;background:var(--g);min-width:42px}.ht td{padding:2px;border:1px solid rgba(0,0,0,.03);text-align:center}
.hc{display:inline-flex;align-items:center;justify-content:center;border-radius:3px;padding:4px 3px;min-width:33px;font-size:10px;font-weight:700;width:100%;transition:transform .1s}.hc:hover{transform:scale(1.12);z-index:5;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.14)}.hc.cur{box-shadow:0 0 0 2px #B8860B,0 0 7px rgba(184,134,11,.3);position:relative;z-index:5}
/* FILTER BUTTONS â€” cool slate */
.sht-filters{display:flex;gap:6px;margin-bottom:11px;align-items:center;flex-wrap:wrap}
.sf{padding:4px 12px;border-radius:3px;border:1px solid var(--slatebdr);background:#fff;color:var(--slate);font-size:10px;font-weight:600;cursor:pointer;transition:all .17s;font-family:'Open Sans',sans-serif}
.sf:hover{border-color:#94A3B8;background:#F8FAFC;color:#334155}
.sf.act{background:#334155;border-color:#1E293B;color:#fff}
.sf.act-g{background:var(--g);border-color:var(--gdk);color:#fff}
.sf.act-r{background:var(--red);border-color:#991B1B;color:#fff}
.sf.act-b{background:var(--blue);border-color:#1E40AF;color:#fff}
.sf.act-y{background:var(--gold);border-color:#92400E;color:#fff}
.sh-search{padding:4px 11px;border-radius:3px;border:1px solid var(--slatebdr);font-size:10px;outline:none;flex:1;max-width:200px;font-family:'Open Sans',sans-serif;background:#fafafa}
.sh-search:focus{border-color:#64748B;background:#fff}
.sht-note-r{font-size:9px;color:var(--gray5);margin-left:auto}
/* SH TABLE â€” frozen left columns + group separators */
.sht-outer{border-radius:var(--r);border:1px solid var(--bdr);max-height:calc(100vh - var(--hh) - 160px);width:100%;overflow:scroll;position:relative;display:block}
.sht-outer::-webkit-scrollbar{width:10px;height:10px}
.sht-outer::-webkit-scrollbar-track{background:#F1F5F9;border-radius:4px}
.sht-outer::-webkit-scrollbar-thumb{background:#94A3B8;border-radius:4px;border:2px solid #F1F5F9}
.sht-outer::-webkit-scrollbar-thumb:hover{background:#64748B}
.sht-outer::-webkit-scrollbar-corner{background:#F1F5F9}
.sht{border-collapse:separate;border-spacing:0;font-size:11px;width:max-content}

/* Sticky header rows */
.sht thead tr:nth-child(1) th{position:sticky;top:0;z-index:20}
.sht thead tr:nth-child(2) th{position:sticky;top:26px;z-index:20}

/* Sticky left columns (freeze first 5: chk, #, name, grp, status) */
.sht th.fc, .sht td.fc{position:sticky;z-index:15}
.sht td.fc{background:#fff;isolation:isolate}
.sht thead th.fc{z-index:26;background:var(--gdk)}
.sht thead tr:nth-child(2) th.fc{z-index:26}
/* Shadow divider after last frozen col */
.sht .fc4::after{content:'';position:absolute;right:-10px;top:0;bottom:0;width:10px;background:linear-gradient(to right,rgba(0,0,0,.13),transparent);pointer-events:none;z-index:1}
.sht .fc0{left:0;min-width:32px;max-width:32px}
.sht .fc1{left:32px;min-width:28px;max-width:28px}
.sht .fc2{left:60px;min-width:200px;max-width:200px}
.sht .fc3{left:260px;min-width:62px;max-width:62px}
.sht .fc4{left:322px;min-width:82px;max-width:82px}

/* Frozen col border shadow effect */

/* Base cell styles */
.sht th{background:var(--gdk);color:rgba(255,255,255,.85);padding:5px 7px;text-align:left;font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;border-bottom:1px solid rgba(255,255,255,.1);border-right:1px solid rgba(255,255,255,.06)}
.sht th.r{text-align:right}.sht th.c{text-align:center}

/* Frozen header cells â€” same dark green background */
.sht thead th.fc{background:var(--gdk)}

/* GROUP HEADER ROW (row 1 of thead) */
.sht th.gh{font-size:9px;font-weight:800;letter-spacing:1.2px;text-transform:uppercase;text-align:center;padding:5px 7px;border-bottom:2px solid rgba(255,255,255,.15);border-right:2px solid rgba(255,255,255,.22)}
/* group colors */
.sht th.gh-id{background:#1E293B} /* identity cols */
.sht th.gh-pos{background:#1E4620;border-right:2px solid rgba(255,255,255,.25)}   /* position */
.sht th.gh-cost{background:#4A3218;border-right:2px solid rgba(255,255,255,.25)}  /* cost/WAC */
.sht th.gh-buy{background:#1E3A5F;border-right:2px solid rgba(255,255,255,.25)}   /* buyout results */
.sht th.gh-cap{background:#3B1E5F;border-right:2px solid rgba(255,255,255,.25)}   /* cap table */
.sht th.gh-gl{background:#3B2A10}                                                  /* G&L */

/* Column header row (row 2) â€” match group color */
.sht thead tr:nth-child(2) th.pos-col{background:#1E4620}
.sht thead tr:nth-child(2) th.cost-col{background:#4A3218}
.sht thead tr:nth-child(2) th.buy-col{background:#1E3A5F}
.sht thead tr:nth-child(2) th.cap-col{background:#3B1E5F}
.sht thead tr:nth-child(2) th.gl-col{background:#3B2A10}

/* Group RIGHT BORDER on data cells to separate sections */
.sht td.sep-r,.sht th.sep-r{border-right:2px solid rgba(0,0,0,.12) !important}
.sht thead th.sep-r{border-right:2px solid rgba(255,255,255,.22) !important}

/* Data cells */
.sht td{padding:5px 7px;border-bottom:1px solid var(--gray1);border-right:1px solid rgba(0,0,0,.03);background:#fff;white-space:nowrap}
.sht td.r{text-align:right;font-variant-numeric:tabular-nums;font-weight:600;font-size:10.5px}
.sht td.c{text-align:center}

/* Row states */
.sht tr.r-out td{background:#F4FCF7}
.sht tr.r-out:hover td{background:#DCFCE7}
.sht tr:not(.r-out):not(.r-excl):hover td{background:#F8FAFF}
.sht tr.r-excl td{opacity:.38;background:#FEF2F2}

/* Frozen data cells keep row color */
.sht tr.r-out td.fc{background:#F4FCF7}.sht tr.r-out:hover td.fc{background:#DCFCE7}
.sht tr:not(.r-out):not(.r-excl):hover td.fc{background:#F8FAFF}
.sht tr.r-excl td.fc{background:#FEF2F2}

.sh-name{font-weight:600;color:var(--gray9);font-size:11px;display:block;overflow:hidden;text-overflow:ellipsis;max-width:195px}
.excl-chk{width:13px;height:13px;cursor:pointer;accent-color:var(--red)}
.stt{display:inline-flex;padding:2px 7px;border-radius:10px;font-size:9px;font-weight:700;white-space:nowrap}
.stt-out{background:var(--gpale);color:var(--g);border:1px solid #BBF7D0}.stt-in{background:var(--goldt);color:#78590A;border:1px solid #FDE68A}.stt-excl{background:var(--redt);color:var(--red);border:1px solid #FECACA}
.gp{display:inline-block;padding:1px 5px;border-radius:2px;font-size:9px;font-weight:700;text-transform:uppercase}
.gp-d{background:var(--redt);color:var(--red)}.gp-o{background:var(--bluet);color:var(--blue)}
.pl-p{color:var(--g);font-weight:700}.pl-n{color:var(--red);font-weight:700}
.sh-cnt2{font-size:9px;color:var(--gray5);margin-top:6px;text-align:right}
/* INFO BAR */
.info-bar{padding:9px 13px;border-radius:var(--r);margin-bottom:13px;font-size:11px;line-height:1.5;border-left:3px solid}
.info-bar.info{background:#EFF6FF;border-color:var(--blue);color:#1E3A8A}
/* COMPARE */
.cmp-tbl{width:100%;border-collapse:collapse;font-size:11px}
.cmp-tbl tr:nth-child(even){background:var(--gray1)}.cmp-tbl th{padding:7px 10px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--gray5);border-bottom:2px solid var(--bdr);background:#fff}.cmp-tbl th.c{text-align:center}.cmp-tbl td{padding:7px 10px;border-bottom:1px solid var(--bdr)}.cmp-tbl td.c{text-align:center;font-weight:700}
.ck-ok{color:var(--g)}.ck-warn{color:var(--gold)}.ck-no{color:var(--gray5)}
/* METHODOLOGY */
.meth-sec{background:#fff;border-radius:var(--r);border:1px solid var(--bdr);margin-bottom:14px;overflow:hidden}
.meth-hdr{background:#1E293B;color:#fff;padding:11px 17px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.meth-hdr-title{font-size:12px;font-weight:700}
.mb{font-size:9px;font-weight:700;padding:3px 9px;border-radius:10px;text-transform:uppercase;letter-spacing:.6px;white-space:nowrap}
.mb-f{background:rgba(255,255,255,.14);color:#fff}.mb-ok{background:#16A34A;color:#fff}.mb-warn{background:#CA8A04;color:#fff}
.meth-body{padding:17px}
.meth-body p{font-size:11px;color:var(--gray7);line-height:1.65;margin-bottom:9px}
.code-blk{background:#0F172A;border-radius:5px;padding:12px 15px;margin:10px 0;font-family:'Courier New',monospace;font-size:11px;color:#E2E8F0;line-height:1.75;border-left:3px solid var(--glt);overflow-x:auto;white-space:pre}
.code-blk .cm{color:#64748B}.code-blk .hl{color:#6EE7B7;font-weight:700}.code-blk .vl{color:#FCD34D}
.meth-tbl{width:100%;border-collapse:collapse;font-size:11px;margin:10px 0}
.meth-tbl th{background:#1E293B;color:rgba(255,255,255,.85);padding:6px 10px;text-align:left;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.meth-tbl th.r{text-align:right}
.meth-tbl td{padding:6px 10px;border-bottom:1px solid var(--bdr);font-size:11px}
.meth-tbl td.r{text-align:right;font-family:'Courier New',monospace;font-size:10.5px;font-weight:600;color:var(--gray9)}
.meth-tbl tr:nth-child(even){background:var(--gray1)}
.step{display:flex;gap:11px;align-items:flex-start;margin-bottom:11px}
.step-n{width:22px;height:22px;border-radius:50%;background:var(--gdk);color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0;margin-top:1px}
.step-b{flex:1;font-size:11px;color:var(--gray7);line-height:1.6}.step-b b{color:var(--gray9)}
.chk-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px}
.chk{border-radius:var(--r);border:1px solid var(--bdr);padding:11px 13px;display:flex;gap:10px;align-items:flex-start}
.chk.pass{border-color:#BBF7D0;background:#F0FBF4}.chk.fail{border-color:#FECACA;background:#FEF2F2}
.chk-icon{font-size:15px;flex-shrink:0;margin-top:1px}
.chk-title{font-size:11px;font-weight:700;color:var(--gray9);margin-bottom:2px}.chk-detail{font-size:10px;color:var(--gray5);line-height:1.5}
.cv{font-family:'Courier New',monospace;font-size:10px;color:var(--gdk);font-weight:600}
.trace-tbl{width:100%;border-collapse:collapse;font-size:11px}
.trace-tbl th{background:#1E293B;color:rgba(255,255,255,.82);padding:6px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;text-align:left}
.trace-tbl th.r{text-align:right}
.trace-tbl td{padding:6px 10px;border-bottom:1px solid var(--bdr)}
.trace-tbl td.r{text-align:right;font-family:'Courier New',monospace;font-weight:700;color:var(--gray9)}
.trace-tbl tr:nth-child(even){background:var(--gray1)}
.footer{background:var(--gdk);color:rgba(255,255,255,.3);font-size:9px;text-align:center;padding:10px;letter-spacing:1px;text-transform:uppercase;margin-top:18px;border-radius:var(--r)}
code{background:var(--gray1);padding:1px 5px;border-radius:3px;font-size:10.5px;font-family:'Courier New',monospace}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.kpi{animation:fadeUp .3s ease both}
.kpi:nth-child(1){animation-delay:.04s}.kpi:nth-child(2){animation-delay:.08s}.kpi:nth-child(3){animation-delay:.12s}.kpi:nth-child(4){animation-delay:.16s}.kpi:nth-child(5){animation-delay:.2s}
.exp-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;border-radius:5px;border:none;font-family:'Open Sans',sans-serif;font-size:11px;font-weight:700;cursor:pointer;letter-spacing:.3px;transition:all .18s;white-space:nowrap}
.exp-xl{background:#1E6B3C;color:#fff}.exp-xl:hover{background:#2E8B57;box-shadow:0 2px 8px rgba(30,107,60,.4)}
.exp-pdf{background:#B91C1C;color:#fff}.exp-pdf:hover{background:#DC2626;box-shadow:0 2px 8px rgba(185,28,28,.4)}
.exp-btn:active{transform:scale(.96)}.exp-btn:disabled{opacity:.55;cursor:wait}
.exp-btn svg{flex-shrink:0}
#exp-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:14px}
#exp-overlay.show{display:flex}
.exp-spinner{width:44px;height:44px;border:4px solid rgba(255,255,255,.2);border-top-color:#6EE7B7;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.exp-msg{color:#fff;font-family:'Open Sans',sans-serif;font-size:13px;font-weight:600}
</style>
</head>
<body>
<div id="exp-overlay"><div class="exp-spinner"></div><div class="exp-msg" id="exp-msg">Gerando exportaÃ§Ã£o...</div></div>
<header class="hdr">
  <div class="hdr-logo">
    <img src="https://www.braziliannickel.com/wp-content/uploads/2023/05/BRNlogoNEW.jpg" alt="BRN"
         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
    <div class="hdr-logo-fb">
      <div class="hdr-logo-fb-box">BRN</div>
      <div><div class="ln1">BRAZILIAN</div><div class="ln2">NICKEL</div><div class="ln3">LIMITED</div></div>
    </div>
  </div>
  <div class="hdr-titles">
    <div class="hdr-title">Minority Shareholder Buyout â€” Scenario &amp; Sensitivity Dashboard</div>
    <div class="hdr-sub">Board of Directors Â· 71 Shareholders Â· Model verified against BRN workbook</div>
  </div>
  <div class="hdr-right">
    <span class="badge b-conf">Confidential</span>
    <span class="badge b-sc" id="hdr-sc">Scenario IV</span>
    <span class="b-date" id="hdr-date"></span>
  </div>
</header>

<div class="layout">
<aside class="sb">
  <!-- SCENARIO SELECTION -->
  <div class="sb-sec">
    <div class="sb-hdr">Cap Table Scenario</div>
    <div class="sc-row">
      <div class="sc-btn" data-sc="I" onclick="setSc('I')">I</div>
      <div class="sc-btn" data-sc="II" onclick="setSc('II')">II</div>
      <div class="sc-btn" data-sc="III" onclick="setSc('III')">III</div>
      <div class="sc-btn act" data-sc="IV" onclick="setSc('IV')">IV</div>
      <div class="sc-btn" data-sc="V" onclick="setSc('V')">V</div>
    </div>
    <div class="sc-desc-box">
      <div class="sc-desc" id="sc-desc">All CLNs converted including CLN 1 + 3rd &amp; 4th warrants</div>
      <div class="sc-stats">
        <span>Total BRN shares: <b id="sb-sh">644.2M</b></span>
        <span>Techmet base: <b id="sb-tm-base">86.65%</b></span>
      </div>
    </div>
  </div>

  <!-- PRICE / VALUATION SELECTORS -->
  <div class="sb-sec">
    <div class="sb-hdr">Share Price â€” Tranche Valuations</div>
    <div class="fv-ctrl">
      <div class="fv-ctrl-lbl">1st Tranche valuation (FV)</div>
      <div class="fv-sel-wrap">
        <select class="fv-sel" id="fv1-sel" onchange="setFV1(+this.value)">
          <option value="150">$150M â€” Conservative</option>
          <option value="200">$200M</option>
          <option value="250">$250M</option>
          <option value="300" selected>$300M â€” Workbook default</option>
          <option value="350">$350M</option>
          <option value="400">$400M</option>
          <option value="450">$450M â€” Optimistic</option>
        </select>
      </div>
      <div class="fv-price-line">â†’ p1 = <b id="sb-p1-live">$0.4657</b> / share</div>
    </div>
    <div class="fv-ctrl" style="margin-top:8px">
      <div class="fv-ctrl-lbl">2nd Tranche valuation (FV)</div>
      <div class="fv-sel-wrap">
        <select class="fv-sel" id="fv2-sel" onchange="setFV2(+this.value)">
          <option value="150">$150M â€” Conservative</option>
          <option value="200">$200M</option>
          <option value="250">$250M</option>
          <option value="300">$300M</option>
          <option value="350" selected>$350M â€” Workbook default</option>
          <option value="400">$400M</option>
          <option value="450">$450M â€” Optimistic</option>
        </select>
      </div>
      <div class="fv-price-line">â†’ p2 = <b id="sb-p2-live">$0.5433</b> / share</div>
    </div>
  </div>

  <!-- BUYOUT PARAMETERS -->
  <div class="sb-sec">
    <div class="sb-hdr">Buyout Parameters</div>
    <div class="ctrl"><div class="ctrl-top"><span class="ctrl-lbl">Total Budget</span><span class="ctrl-val" id="cv-b">$4.0M</span></div><input type="range" id="sl-b" min=".5" max="10" step=".5" value="4" oninput="onS('b',+this.value)"><div class="ctrl-range"><span>$0.5M</span><span>$10M</span></div></div>
    <div class="ctrl"><div class="ctrl-top"><span class="ctrl-lbl">1st Tranche Split</span><span class="ctrl-val" id="cv-sp">75%</span></div><input type="range" id="sl-sp" min="5" max="95" step="5" value="75" oninput="onS('sp',+this.value)"><div class="ctrl-range"><span>5%</span><span>95%</span></div></div>
    <div class="ctrl"><div class="ctrl-top"><span class="ctrl-lbl">Cap / SH â€” 1st</span><span class="ctrl-val" id="cv-c1">$75k</span></div><input type="range" id="sl-c1" min="5" max="500" step="5" value="75" oninput="onS('c1',+this.value)"><div class="ctrl-range"><span>$5k</span><span>$500k</span></div></div>
    <div class="ctrl"><div class="ctrl-top"><span class="ctrl-lbl">Cap / SH â€” 2nd</span><span class="ctrl-val" id="cv-c2">$40k</span></div><input type="range" id="sl-c2" min="5" max="500" step="5" value="40" oninput="onS('c2',+this.value)"><div class="ctrl-range"><span>$5k</span><span>$500k</span></div></div>
  </div>

  <!-- LIVE RESULTS -->
  <div class="sb-sec">
    <div class="sb-hdr">Live Results</div>
    <div class="sb-kpis">
      <div class="sb-kpi"><div class="sb-kpi-val kv-g" id="sk-rem">â€”</div><div class="sb-kpi-meta"><div class="lbl">Fully Exiting</div><div class="sub" id="sk-rem-s">of 71</div></div></div>
      <div class="sb-kpi"><div class="sb-kpi-val kv-y" id="sk-dist">â€”</div><div class="sb-kpi-meta"><div class="lbl">Distributed</div><div class="sub" id="sk-util">â€”</div></div></div>
      <div class="sb-kpi"><div class="sb-kpi-val kv-g" id="sk-tm">â€”</div><div class="sb-kpi-meta"><div class="lbl">Techmet After</div><div class="sub">ownership %</div></div></div>
    </div>
    <div class="opt-wrap">
      <div class="opt-top"><div class="opt-score" id="sk-opt">â€”</div><div class="opt-lbl">Efficiency Score</div></div>
      <div class="opt-track"><div class="opt-fill" id="opt-fill"></div></div>
      <div class="opt-note" id="opt-note">â€”</div>
    </div>
  </div>

  <!-- PRESETS -->
  <div class="sb-sec">
    <div class="sb-hdr">Presets</div>
    <div class="preset-list">
      <button class="preset-btn act" onclick="applyP('opt',this)">Optimal A â€” Max exits</button>
      <button class="preset-btn" onclick="applyP('full',this)">Max budget utilization</button>
      <button class="preset-btn" onclick="applyP('orig',this)">Original Sc.IV ($30k/$50k)</button>
    </div>
  </div>
</aside>

<main class="main">
  <div class="info-bar info" id="excl-bar" style="display:none">
    <b>Custom pool active:</b> <span id="excl-bar-txt"></span> shareholders excluded from buyout.
    <a href="#" onclick="clearExcl();return false" style="color:var(--blue);font-weight:700">Reset to all 71</a>
  </div>

  <div class="kpi-row">
    <div class="kpi g"><div class="kpi-lbl">Fully Exiting Cap Table</div><div class="kpi-val" id="k-rem">â€”</div><div class="kpi-sub" id="k-rem-s">â€”</div><span class="kpi-pill pill-g" id="k-rem-p">â€”</span></div>
    <div class="kpi y"><div class="kpi-lbl">Total Distributed</div><div class="kpi-val" id="k-dist">â€”</div><div class="kpi-sub" id="k-dist-s">â€”</div><span class="kpi-pill pill-y" id="k-util">â€”</span></div>
    <div class="kpi r"><div class="kpi-lbl">Remaining in Cap Table</div><div class="kpi-val" id="k-stay">â€”</div><div class="kpi-sub" id="k-stay-sub">shareholders still present</div></div>
    <div class="kpi b"><div class="kpi-lbl">Techmet Ownership After</div><div class="kpi-val" id="k-tm">â€”</div><div class="kpi-sub">base: 86.65% (Sc.IV)</div></div>
    <div class="kpi n"><div class="kpi-lbl">Net G&amp;L â€” All Participants</div><div class="kpi-val" id="k-pl">â€”</div><div class="kpi-sub">vs investment cost basis</div></div>
  </div>

  <div class="tabs">
    <button class="tab act" onclick="switchTab('results',this)">Results Overview</button>
    <button class="tab" onclick="switchTab('sensitivity',this)">Sensitivity Analysis</button>
    <button class="tab" onclick="switchTab('shareholders',this)">Shareholder Detail</button>
    <button class="tab" onclick="switchTab('methodology',this)">Methodology &amp; Checks</button>
  </div>

  <!-- â•â•â• RESULTS â•â•â• -->
  <div class="tp act" id="tp-results">
    <div class="g3">
      <div class="card">
        <div class="card-title">Cap Table After Buyout <span class="cbadge cb-g">By status</span></div>
        <div class="card-desc">Shareholders who sell all issued shares (fully exit) vs those who remain with partial holdings.</div>
        <div class="donut-row">
          <div class="donut-wrap"><canvas id="d1"></canvas></div>
          <div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--g)"></div><div class="dl-name">Fully Exit</div><div class="dl-val" id="dl-rem">â€”</div></div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--red)"></div><div class="dl-name">Disputing â€” Stay</div><div class="dl-val" id="dl-ds">â€”</div></div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--blue)"></div><div class="dl-name">Other â€” Stay</div><div class="dl-val" id="dl-os">â€”</div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Distribution by Group <span class="cbadge cb-y">Amounts paid</span></div>
        <div class="card-desc">How total payout splits across Disputing vs Other SH groups, and any unspent budget.</div>
        <div class="donut-row">
          <div class="donut-wrap"><canvas id="d2"></canvas></div>
          <div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--red)"></div><div class="dl-name">Disputing SH</div><div class="dl-val" id="dl-dd">â€”</div></div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--blue)"></div><div class="dl-name">Other SH</div><div class="dl-val" id="dl-od">â€”</div></div>
            <div class="dl-item"><div class="dl-dot" style="background:var(--gray3)"></div><div class="dl-name">Unspent</div><div class="dl-val" id="dl-un">â€”</div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Techmet Ownership <span class="cbadge cb-b">Sc.IV basis</span></div>
        <div class="card-desc">Techmet starts at 86.65%. Repurchasing minority shares increases this incrementally.</div>
        <div class="tm-big" id="tm-pct">â€”</div>
        <div class="tm-sub">after buyout</div>
        <div class="tm-track"><div class="tm-fill" id="tm-fill" style="width:0%"></div></div>
        <div class="tm-2col">
          <div class="tm-box tm-b0"><div class="tm-num" style="font-size:13px">86.65%</div><div class="tm-lbl">Base (before)</div></div>
          <div class="tm-box tm-b1"><div class="tm-num" id="tm-after" style="font-size:13px">â€”</div><div class="tm-lbl">After buyout</div></div>
        </div>
        <div class="tm-2col" style="margin-top:7px">
          <div class="tm-box tm-b0"><div class="tm-num" id="tm-nb">71</div><div class="tm-lbl">SH before</div></div>
          <div class="tm-box tm-b1"><div class="tm-num" id="tm-na">â€”</div><div class="tm-lbl">SH after</div></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin-bottom:13px">
      <div class="card-title">Distribution per Shareholder <span class="cbadge cb-g">All participants Â· sorted by amount received</span></div>
      <div class="card-desc">1st tranche (green) + 2nd tranche (amber). Full-color = fully exits cap table. Faded = stays with partial holdings.</div>
      <div style="position:relative;height:330px"><canvas id="ch-bars"></canvas></div>
    </div>
    <div class="g2">
      <div class="card">
        <div class="card-title">G&amp;L per Shareholder <span class="cbadge cb-y">Offer price vs cost basis</span></div>
        <div class="card-desc">G/L = (p1 âˆ’ issued_cost/total_shares) Ã— shares_sold. Green = gain on exit. Red = accepts a loss to exit.</div>
        <div style="position:relative;height:290px"><canvas id="ch-pl"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Exit Rate by Group <span class="cbadge cb-r">Disputing vs Other</span></div>
        <div class="card-desc">Removing Disputing SH eliminates active litigation exposure â€” primary strategic goal of the buyout.</div>
        <div style="position:relative;height:185px"><canvas id="ch-grp"></canvas></div>
        <div class="info-bar info" style="margin-top:10px;margin-bottom:0;font-size:10px">
          <b>34 Disputing SH</b> carry active legal claims against BRN. Full removal eliminates all related litigation risk.
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• SENSITIVITY â•â•â• -->
  <div class="tp" id="tp-sensitivity">
    <!-- PRICE Ã— SCENARIO MATRIX (from workbook) -->
    <div class="card" style="margin-bottom:13px">
      <div class="card-title">
        Price per Share â€” All Scenarios Ã— All Valuations
        <span class="cbadge cb-y">Gold border = active selection</span>
      </div>
      <div class="card-desc">
        Exact values from workbook (1_Sensitivity Analysis rows 57â€“63). Each cell = share price at that valuation (FV) and cap table scenario.
        Rows highlight when the row matches your selected FV. Gold outline = your exact current selection.
      </div>
      <div style="overflow-x:auto">
        <table class="psh-tbl" id="psh-tbl">
          <thead>
            <tr>
              <th class="rh">Valuation (FV)</th>
              <th title="192,823,116 shares â€” Prior to 3rd/4th CLN conversion">Sc. I<br><span style="font-weight:400;font-size:8px;opacity:.6">192.8M sh</span></th>
              <th title="483,367,477 shares â€” Actual Cap Table">Sc. II<br><span style="font-weight:400;font-size:8px;opacity:.6">483.4M sh</span></th>
              <th title="575,094,676 shares â€” All CLNs excl. CLN1">Sc. III<br><span style="font-weight:400;font-size:8px;opacity:.6">575.1M sh</span></th>
              <th title="644,173,254 shares â€” All CLNs incl. CLN1">Sc. IV<br><span style="font-weight:400;font-size:8px;opacity:.6">644.2M sh</span></th>
              <th title="665,589,197 shares â€” Fully diluted">Sc. V<br><span style="font-weight:400;font-size:8px;opacity:.6">665.6M sh</span></th>
              <th style="background:#2D3748;font-size:8.5px">SH Exiting<br>(current caps)</th>
              <th style="background:#2D3748;font-size:8.5px">Budget Used<br>(%)</th>
            </tr>
          </thead>
          <tbody id="psh-tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="g2">
      <div class="card">
        <div class="card-title">SH Fully Exiting â€” Cap Grid <span class="cbadge cb-g">Gold border = current</span></div>
        <div class="card-desc">Rows = 2nd cap/SH. Cols = 1st cap/SH. Cell = # SH whose issued shares fully reach zero.</div>
        <div class="heat-wrap" id="heat-rem"></div>
      </div>
      <div class="card">
        <div class="card-title">Budget Utilization % â€” Cap Grid <span class="cbadge cb-y">% of budget paid out</span></div>
        <div class="card-desc">What % of the budget actually reaches shareholders. Unspent occurs when all SH hit their caps.</div>
        <div class="heat-wrap" id="heat-util"></div>
      </div>
    </div>
    <div class="g2">
      <div class="card">
        <div class="card-title">Budget Split Sensitivity</div>
        <div class="card-desc">Effect of varying 1st/2nd tranche split % on exits and budget utilization.</div>
        <div style="position:relative;height:185px"><canvas id="ch-split"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Total Budget Sensitivity</div>
        <div class="card-desc">How fully exiting SH count changes with total budget. Darker = at/above reference exits.</div>
        <div style="position:relative;height:185px"><canvas id="ch-bud"></canvas></div>
      </div>
    </div>
    <div class="g2">
      <div class="card">
        <div class="card-title">1st Tranche Price Sensitivity</div>
        <div class="card-desc">Higher price â†’ small SH share value drops below cap â†’ they fully exit. Large SH always hit cap.</div>
        <div style="position:relative;height:185px"><canvas id="ch-price"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">Current vs Reference Benchmark</div>
        <div class="card-desc">Comparison against Optimal A preset (best known combination of exits + budget utilization).</div>
        <table class="cmp-tbl"><thead><tr><th>Metric</th><th class="c">Optimal A</th><th class="c">Current</th><th class="c">Status</th></tr></thead><tbody id="cmp-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- â•â•â• SHAREHOLDERS â•â•â• -->
  <div class="tp" id="tp-shareholders">
    <div class="info-bar info" style="margin-bottom:12px">
      <b>Exclude from pool:</b> Check the box to remove any shareholder from the buyout. All metrics recalculate instantly with renormalized pro-rata weights.
      <a href="#" onclick="clearExcl();return false" style="color:var(--blue);font-weight:700">Reset all</a>
    </div>
    <div class="sht-filters">
      <button class="sf act" data-f="all" onclick="setF('all',this)">All (71)</button>
      <button class="sf" data-f="out" onclick="setF('out',this)">Fully Exiting</button>
      <button class="sf" data-f="in" onclick="setF('in',this)">Staying</button>
      <button class="sf" data-f="D" onclick="setF('D',this)">Disputing</button>
      <button class="sf" data-f="O" onclick="setF('O',this)">Other</button>
      <button class="sf" data-f="excl" onclick="setF('excl',this)">Excluded</button>
      <input type="text" class="sh-search" id="sh-q" placeholder="Search nameâ€¦" oninput="renderSH()">
      <span class="sht-note-r" id="sh-cnt">â€”</span>
    </div>
    <div class="sht-outer">
      <table class="sht">
        <thead>
          <!-- ROW 1: Group headers -->
          <tr>
            <th class="fc fc0 gh gh-id c" colspan="5">Identity</th>
            <th class="gh gh-pos" colspan="3">ðŸ“Š Position</th>
            <th class="gh gh-cost" colspan="6">ðŸ’° Investment Cost &amp; WAC</th>
            <th class="gh gh-buy" colspan="6">ðŸ“¤ Buyout Results</th>
            <th class="gh gh-cap" colspan="4">ðŸ“‹ Cap Table After Buyout</th>
            <th class="gh gh-gl" colspan="3">ðŸ“ˆ Gain &amp; Loss</th>
          </tr>
          <!-- ROW 2: Column headers -->
          <tr>
            <th class="fc fc0 c" title="Exclude from pool">Ex.</th>
            <th class="fc fc1" style="font-size:8px">#</th>
            <th class="fc fc2" style="min-width:200px">Shareholder</th>
            <th class="fc fc3 c">Grp</th>
            <th class="fc fc4 sep-r" style="min-width:82px">Status</th>
            <!-- POSITION (green-tinted) -->
            <th class="r pos-col" title="Ordinary issued shares">Issued Sh.</th>
            <th class="r pos-col" title="CLN convertible option shares">CLN Opts</th>
            <th class="r pos-col sep-r" title="Total = Issued + CLN options">Total Sh.</th>
            <!-- COST (amber-tinted) -->
            <th class="r cost-col" title="Cost paid for issued shares (Cash Value sheet)">Iss. Cost $</th>
            <th class="r cost-col" title="CLN cost incl. accrued interest (3_CLN sheet)">CLN Cost $</th>
            <th class="r cost-col" title="Total investment = Iss. Cost + CLN Cost">Total Cost $</th>
            <th class="r cost-col" title="WAC Issued = iss_cost / issued_shares (workbook col W)">WAC Issued</th>
            <th class="r cost-col" title="WAC CLN = cln_cost / cln_option_shares">WAC CLN</th>
            <th class="r cost-col sep-r" title="WAC Blended = total_cost / total_shares">WAC Blend</th>
            <!-- BUYOUT RESULTS (blue-tinted) -->
            <th class="r buy-col">1st Tr. $</th>
            <th class="r buy-col">2nd Tr. $</th>
            <th class="r buy-col">Total Recv $</th>
            <th class="r buy-col" title="Shares sold 1st = recv1 / p1">Sh Sold 1st</th>
            <th class="r buy-col" title="Shares sold 2nd = recv2 / p2">Sh Sold 2nd</th>
            <th class="r buy-col sep-r" title="Total shares sold across both tranches">Total Sold</th>
            <!-- CAP TABLE (purple-tinted) -->
            <th class="r cap-col" title="Issued shares before buyout">Iss. Before</th>
            <th class="r cap-col" title="Issued shares remaining after both tranches">Iss. After</th>
            <th class="r cap-col" title="CLN options: retained if partial exit, removed if fully exits">CLN After</th>
            <th class="r cap-col sep-r" title="Total remaining position on cap table">Total After</th>
            <!-- G&L (brown-tinted) -->
            <th class="r gl-col" title="Avg sell = total_received / total_shares_sold">Avg Sell/sh</th>
            <th class="r gl-col" title="G/L per share = p1 âˆ’ (iss_cost / total_shares) Â· workbook col AE">G/L per sh</th>
            <th class="r gl-col" title="G/L total = G/L per sh Ã— total shares sold Â· workbook col AH">G/L Total $</th>
          </tr>
        </thead>
        <tbody id="sh-tbody"></tbody>
      </table>
    </div>
    <div class="sh-cnt2" id="sh-cnt2">â€”</div>
  </div>

  <!-- â•â•â• METHODOLOGY â•â•â• -->
  <div class="tp" id="tp-methodology">

    <div class="meth-sec">
      <div class="meth-hdr">
        <div class="meth-hdr-title">Dashboard Validation Checks â€” Live</div>
        <span class="mb mb-ok" id="chk-badge">Runningâ€¦</span>
      </div>
      <div class="meth-body">
        <p>All checks run on every parameter change. They verify the calculation engine against the BRN workbook values and internal mathematical consistency.</p>
        <div class="chk-grid" id="chk-grid"></div>
        <p id="chk-summary" style="color:var(--gray5);margin-top:4px;font-size:10px"></p>
      </div>
    </div>

    <div class="meth-sec">
      <div class="meth-hdr"><div class="meth-hdr-title">1 â€” Pool, Pro-Rata &amp; Data</div><span class="mb mb-f">Source: 2_Shareholders Dilution</span></div>
      <div class="meth-body">
        <p><b>71 minority shareholders</b> in two groups: 34 Disputing (active litigation) + 37 Other (founders, employees, early investors). Each holds <i>Issued Shares</i> (can be sold in buyout) and may also hold <i>CLN Options</i> (convertible loan note rights â€” stay on cap table unless fully exiting).</p>
        <table class="meth-tbl">
          <thead><tr><th>Group</th><th>SH</th><th>Issued Shares</th><th>CLN Options</th><th class="r">Total Position</th><th class="r">% of Pool</th></tr></thead>
          <tbody>
            <tr><td>Disputing</td><td>34</td><td>16,658,696</td><td>1,049,076</td><td class="r">17,707,772</td><td class="r">20.58%</td></tr>
            <tr><td>Other</td><td>37</td><td>63,633,986</td><td>4,680,843</td><td class="r">68,314,829</td><td class="r">79.42%</td></tr>
            <tr><td><b>Total</b></td><td><b>71</b></td><td><b>80,292,682</b></td><td><b>5,729,919</b></td><td class="r"><b>86,022,601</b></td><td class="r"><b>100%</b></td></tr>
          </tbody>
        </table>
        <p><b>Pro-rata weight</b> uses <em>issued shares only</em> (matching workbook col L formula) and is renormalized across the active pool only:</p>
        <div class="code-blk"><span class="hl">pr_i</span> = <span class="vl">issued_i</span> / sum(<span class="vl">issued</span> for all <b>active</b> SH)
<span class="cm">-- "Active" = not excluded by user checkbox
-- CLN options are NOT used in pro-rata weight
-- Renormalized whenever exclusion set changes</span></div>
      </div>
    </div>

    <div class="meth-sec">
      <div class="meth-hdr"><div class="meth-hdr-title">2 â€” Iterative Pro-Rata Distribution with Cap Redistribution</div><span class="mb mb-f">Core Algorithm</span></div>
      <div class="meth-body">
        <p>Each tranche uses an <b>iterative pro-rata with redistribution</b>. When a shareholder hits their effective cap, the surplus is returned to the remaining pool and redistributed â€” ensuring maximum budget utilization and maximum exits.</p>
        <div class="step"><div class="step-n">1</div><div class="step-b"><b>Effective cap per SH:</b> <code>eff_cap_i = min(cap_param, available_issued_i Ã— price)</code>. This bounds payouts to what the SH's shares are actually worth â€” a SH cannot receive more than the value of their available issued shares.</div></div>
        <div class="step"><div class="step-n">2</div><div class="step-b"><b>Shares sold:</b> <code>shares_sold = amount_received / price</code>. The cap limits the money received; shares sold follow directly from the price. If <code>issued_shares Ã— price â‰¤ cap</code>, the SH sells <em>all</em> their issued shares and fully exits.</div></div>
        <div class="step"><div class="step-n">3</div><div class="step-b"><b>Cap redistribution:</b> SH who hit their <code>eff_cap</code> are locked. The remaining budget (what they would have received above cap) is returned to the pool and redistributed pro-rata among the remaining SH. Loop repeats until no more caps or budget exhausted.</div></div>
        <div class="step"><div class="step-n">4</div><div class="step-b"><b>2nd tranche available shares:</b> After 1st tranche, each SH's available issued shares = <code>max(0, issued âˆ’ sold_1st)</code>. Pro-rata weights are unchanged between tranches.</div></div>
        <div class="code-blk"><span class="cm">-- For each tranche (1st then 2nd):</span>
avail[i] = issued[i]  <span class="cm">(2nd tranche: avail[i] = issued[i] âˆ’ sold_1st[i])</span>
eff_cap[i] = min(cap_param, avail[i] Ã— price)
active = all pool SH;  remaining = tranche_budget

<span class="hl">LOOP</span> (max 3000 iterations):
  active = [s : recv[s] &lt; eff_cap[s] âˆ’ Îµ]
  if active empty OR remaining &lt; 0.000001: BREAK
  tw = sum(pr[s] for s in active)
  capped = [s : recv[s] + (pr[s]/tw)Ã—remaining â‰¥ eff_cap[s] âˆ’ Îµ]
  if capped empty:
    recv[s] += (pr[s]/tw) Ã— remaining  for all active  â†’  <span class="hl">BREAK</span>
  else:
    for s in capped: remaining âˆ’= eff_cap[s]âˆ’recv[s]; recv[s] = eff_cap[s]
    active = active âˆ’ capped

shares_sold[i] = recv[i] / price
fully_exits = (issued[i] âˆ’ sold_1st[i] âˆ’ sold_2nd[i]) &lt; 0.5</div>
      </div>
    </div>

    <div class="meth-sec">
      <div class="meth-hdr"><div class="meth-hdr-title">3 â€” WAC, Cost Basis &amp; G/L (Verified vs BRN Workbook)</div><span class="mb mb-f">Formulas from cols AE, AH</span></div>
      <div class="meth-body">
        <p>Three WAC measures are shown in the Shareholder Detail table. The G/L formula is derived directly from workbook column AE: <code>=âˆ’(Z/AM + U/G)</code> where Z=recv_1st, AM=âˆ’sold_1st, U=issued_cost, G=total_shares.</p>
        <div class="code-blk"><span class="cm">-- WAC MEASURES (all three shown in Shareholder Detail)</span>
<span class="hl">WAC_issued</span>  = <span class="vl">iss_cost</span> / <span class="vl">issued_shares</span>             <span class="cm">â† workbook col W</span>
<span class="hl">WAC_cln</span>     = <span class="vl">cln_cost</span> / <span class="vl">cln_option_shares</span>         <span class="cm">â† CLN-only cost/share</span>
<span class="hl">WAC_blended</span> = (iss_cost + cln_cost) / (issued + cln_opts)  <span class="cm">â† total cost/total position</span>

<span class="cm">-- G/L (from workbook col AE = âˆ’(Z/AM + U/G) )</span>
<span class="hl">pl_per_share</span> = <span class="vl">p1</span> âˆ’ (<span class="vl">iss_cost</span> / <span class="vl">total_shares</span>)
<span class="cm">  where total_shares = issued + cln_opts
  Note: uses iss_cost only (not cln_cost) but denominator = total position</span>

<span class="hl">avg_sell_price</span> = total_received / total_shares_sold
<span class="hl">pl_total</span>      = pl_per_share Ã— (sold_1st + sold_2nd)   <span class="cm">â† workbook col AH</span></div>
        <p><b>Verified example â€” Harpia Harpyja Capital Limited (Sc.IV, original $30k/$50k caps):</b></p>
        <table class="meth-tbl">
          <thead><tr><th>Item</th><th class="r">Value</th><th>Derivation / Workbook ref</th></tr></thead>
          <tbody>
            <tr><td>Issued shares</td><td class="r">6,397,033</td><td>Col E</td></tr>
            <tr><td>CLN option shares</td><td class="r">604,325</td><td>Col F</td></tr>
            <tr><td>Total shares (G)</td><td class="r">7,001,358</td><td>Col G = E+F</td></tr>
            <tr><td>Issued share cost (U)</td><td class="r">$128,147</td><td>Col U â€” Cash Value sheet</td></tr>
            <tr><td>CLN cost incl. interest (T)</td><td class="r">$222,234</td><td>Col T â€” 3_CLN sheet</td></tr>
            <tr><td>WAC_issued = $128,147 / 6,397,033</td><td class="r">$0.02003/sh</td><td>Col W âœ“</td></tr>
            <tr><td>WAC_CLN = $222,234 / 604,325</td><td class="r">$0.36774/sh</td><td>Derived</td></tr>
            <tr><td>WAC_blended = $350,381 / 7,001,358</td><td class="r">$0.05004/sh</td><td>Derived</td></tr>
            <tr><td>1st tranche received (cap = $30k)</td><td class="r">$30,000</td><td>Col Z â€” capped at $30k</td></tr>
            <tr><td>2nd tranche received (cap = $50k)</td><td class="r">$50,000</td><td>Col AA â€” capped at $50k</td></tr>
            <tr><td>Shares sold 1st = $30k / p1</td><td class="r">â‰ˆ 64,417</td><td>Col AM âœ“</td></tr>
            <tr><td>Shares sold 2nd = $50k / p2</td><td class="r">â‰ˆ 92,024</td><td>Col AN âœ“</td></tr>
            <tr><td>Remaining issued = 6,397,033 âˆ’ 156,441</td><td class="r">6,240,592</td><td>Partial exit (stays on cap table)</td></tr>
            <tr><td>p1 (Sc.IV default offer price)</td><td class="r">$0.46571/sh</td><td>1_Sensitivity Analysis E26</td></tr>
            <tr><td><b>G/L per share</b> = $0.46571 âˆ’ ($128,147/7,001,358)</td><td class="r" style="color:var(--g)"><b>â‰ˆ $0.4474/sh</b></td><td>Col AE âœ“ (workbook = 0.44741)</td></tr>
            <tr><td><b>G/L total</b> = $0.4474 Ã— 156,441 shares</td><td class="r" style="color:var(--g)"><b>â‰ˆ $69,994</b></td><td>Col AH âœ“ (workbook = $69,994)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="meth-sec">
      <div class="meth-hdr"><div class="meth-hdr-title">4 â€” Cap Table Movement Summary</div><span class="mb mb-f">Before &amp; after buyout</span></div>
      <div class="meth-body">
        <div class="code-blk"><span class="cm">-- CAP TABLE MOVEMENT per shareholder</span>
Before:  issued_shares + cln_options  (total position)

After 1st tranche:
  sold_1st   = recv_1st / p1  (bounded by eff_cap_1 and available issued)
  avail_2nd  = max(0, issued âˆ’ sold_1st)

After 2nd tranche:
  sold_2nd   = recv_2nd / p2  (bounded by eff_cap_2 and avail_2nd)
  iss_after  = issued âˆ’ sold_1st âˆ’ sold_2nd
  cln_after  = cln_opts  if iss_after â‰¥ 0.5  (stays on cap table)
             = 0          if iss_after &lt; 0.5  (fully exits â€” CLN also removed)
  total_after = iss_after + cln_after

<span class="hl">Full exit</span>  â†”  iss_after &lt; 0.5
<span class="hl">Partial exit</span> â†”  iss_after â‰¥ 0.5  (still on cap table, sold some shares only)

Techmet gains: ALL shares sold across all SH in both tranches
<span class="hl">Techmet_after</span> = 86.646% + Î£(sold_1st + sold_2nd) / 644,173,254</div>
      </div>
    </div>

    <div class="meth-sec">
      <div class="meth-hdr"><div class="meth-hdr-title">5 â€” Live Calculation Trace</div><span class="mb mb-f">Updated on every change</span></div>
      <div class="meth-body">
        <table class="trace-tbl"><thead><tr><th>Variable</th><th class="r">Value</th><th>Description</th></tr></thead><tbody id="trace-tbody"></tbody></table>
      </div>
    </div>
  </div><!-- /methodology -->

  <div class="footer">Confidential Â· Brazilian Nickel Limited Â· Minority Shareholder Buyout Â· Board of Directors Â· February 2026</div>
</main>
</div>

<script>
/* â•â•â•â•â• DATA: 71 SH [name, issued, cln_opts, iss_cost, cln_cost, group] â•â•â•â•â• */
const SH=[
['Harpia Harpyja Capital Limited2',6397033,604325,128147.00,222234.49,'D'],
['The Bartlett Family Company LLC',2338051,0,75249.00,0,'D'],
['Mr Monte Christie',1382900,130641,71234.00,48042.29,'D'],
['Mr Mike Minch',1326515,125178,39542.00,46033.28,'D'],
['David Malcolm Owen',532275,0,88059.00,0,'D'],
['Maria Francisca GuimarÃ£es Montenegro',519973,48908,105574.00,17985.44,'D'],
['Ana Paula de Meira CÃ¢ndido',110000,0,15173.00,0,'D'],
['Antonio Pedro Toulson Davisson Correia',300000,0,41382.00,0,'D'],
['Alexandre Cezar Chagas Luz',406610,38320,56088.00,14091.91,'D'],
['Eugenio Nunes Mamede',388923,0,53648.00,0,'D'],
['Fernando Campos GuimarÃ£es',277189,26185,36577.00,9629.61,'D'],
['Carlos Alberto Maria',271988,25611,37519.00,9418.45,'D'],
['Ricardo Abramof',270055,25489,37251.00,9373.60,'D'],
['Renato GaviÃ£o de Carvalho',247311,0,90382.00,0,'D'],
['Norte Real Estate Empreend. ImobiliÃ¡rios LTDA',205156,0,157384.00,0,'D'],
['Michael Coutinho',197385,0,140789.00,0,'D'],
['Jair Amorim Rangel',192058,0,139150.00,0,'D'],
['Luiz Massayosi Ojima',191292,0,79009.00,0,'D'],
['Marco AurÃ©lio Lopes Pires',155035,0,35609.00,0,'D'],
['Cleber Lima Silva',143509,0,55311.00,0,'D'],
['Claudio Henrique Lyra De Miranda',123690,11631,62439.00,4277.41,'D'],
['Claudio Antonio de Oliveira',94341,0,30593.00,0,'D'],
['Francisco de Assis Lafeta Couto',89856,0,12395.00,0,'D'],
['Marcos Fernando Beluco',88997,0,12276.00,0,'D'],
['Vinicius Silva Ramos',68073,0,19947.00,0,'D'],
['Renato Rodrigues De Almeida',67885,12788,9336.00,4702.79,'D'],
['JosÃ© Carlos Ramos dos Santos',67564,0,19877.00,0,'D'],
['Sergio Correa Guedes',52843,0,7289.00,0,'D'],
['Allison Minch',51516,0,1.00,0,'D'],
['Frederico Gama da Silva',34098,0,4703.00,0,'D'],
['Yvana Naira Moreira Carneiro',22732,0,3136.00,0,'D'],
['Rafael Silveira Zanata',21459,0,4855.00,0,'D'],
['Gareth Mark Owen',11200,0,12117.00,0,'D'],
['Marcelo Tambasco ProenÃ§a',11184,0,12100.00,0,'D'],
['Michael William Oxley',15423970,33820,27766.65,12437.25,'O'],
['Edith Anne Oxley',15395478,0,27364.10,0,'O'],
['Yellowcreek Investments Limited12',9389967,3393887,1490393.10,1248068.34,'O'],
['Paul Lush',7516578,0,77184.25,0,'O'],
['Mark Elliot Smith',7409205,699182,1071332.85,257117.33,'O'],
['APG Aus No 10 Pty Ltd',3909216,368899,2203398.68,135659.25,'O'],
['Link (Wilcza) Corporate PTE. Ltd',832386,0,500000.00,0,'O'],
['Omar Caceres',574796,0,209957.64,0,'O'],
['Claverton Associates Ltd',411575,84318,45422.19,31007.26,'O'],
['John Michael Croft',403060,38035,97.13,13987.15,'O'],
['Krishna P. Sinha and Arati Sinha',288410,0,147605.48,0,'O'],
['Guilherme Andrade dos Anjos Jacome',279736,7522,18041.78,2766.43,'O'],
['SK8 Limited',207208,0,207.21,0,'O'],
['AndrÃ© SimÃ£o Osorio de Barros',200000,0,0,0,'O'],
['GHCP Services Limited',163228,10154,98160.00,3734.36,'O'],
['Per Arne Lorentzen',151436,0,164669.00,0,'O'],
['Colin J. Knight and Joyce L.C. Knight',140000,0,19142.20,0,'O'],
['Figaro Group Ltd.',138139,0,138.14,0,'O'],
['Luara Marshall Rowe',134062,0,18330.30,0,'O'],
['Daniela Nascimento Nogueira',78925,0,10886.89,0,'O'],
['Yasmin de Magalhaes Pinto Almeida',67685,0,9336.42,0,'O'],
['Mark Camilleri',62156,0,11112.30,0,'O'],
['Laura Botelho',61620,0,0,0,'O'],
['ENK Limited',51097,4821,47089.00,1773.19,'O'],
['Marcio Herbes Santos',46711,4407,5779.20,1620.98,'O'],
['Marcelo Rideg Moreira',44560,23063,38814.43,8481.19,'O'],
['Ailton Miranda',39524,3729,21387.03,1371.58,'O'],
['Joyce Oxley',35850,0,68.00,0,'O'],
['William Anthony Oxley',35850,0,68.00,0,'O'],
['Lisa Kathryn Oxley',35850,0,68.00,0,'O'],
['Christian Masurenko',35850,0,68.00,0,'O'],
['Alex Holtzapple',22383,0,19277.65,0,'O'],
['Brendan Patrick Burke',16776,0,18150.00,0,'O'],
['Mario Alberto Beer',15893,9006,3595.96,3312.04,'O'],
['Marina Ferrara',11996,0,2714.33,0,'O'],
['Cleto Luiz De Lima',1405,0,1210.00,0,'O'],
['Rogerio Augusto De Almeida Cavalli Ni Piccinini',1405,0,1210.00,0,'O'],
];

/* â•â• SCENARIO DEFINITIONS â€” verified from workbook 1_Sensitivity Analysis rows 3-7, 55-56 â•â•
   Techmet base % = (total_BRN_shares - minority_total) / total_BRN_shares
   Minority total = 86,022,601 (constant across all scenarios)
   Source: row 56 for total shares; Techmet_IV = 86.646% confirmed workbook row 49
*/
const SC_DATA={
  I:  {shares:192823116, techmetBase:(192823116-86022601)/192823116,
       desc:'Cap Table prior to conversion of 3rd and 4th CLNs',
       tag:'Pre-CLN 3&4 conversion'},
  II: {shares:483367477, techmetBase:(483367477-86022601)/483367477,
       desc:'After conversion of 3rd & 4th CLNs and Warrants â€” Actual Cap Table as of today',
       tag:'Actual Cap Table'},
  III:{shares:575094676, techmetBase:(575094676-86022601)/575094676,
       desc:'All CLNs and warrants converted, excluding CLN 1',
       tag:'All CLNs excl. CLN 1'},
  IV: {shares:644173254, techmetBase:0.8664604584778368,  // exact from workbook row 49
       desc:'All CLNs converted including CLN 1 + 3rd & 4th warrants',
       tag:'All CLNs incl. CLN 1'},
  V:  {shares:665589197, techmetBase:(665589197-86022601)/665589197,
       desc:'Fully diluted â€” all CLNs, warrants, investor option and stock options',
       tag:'Fully Diluted'},
};

/* â•â• PRICE MATRIX: price = FV / total_BRN_shares_for_scenario â•â•
   Source: workbook 1_Sensitivity Analysis rows 57-63 (verified: formula = FV / total_shares)
   Rows = FV valuation ($M); Cols = [Sc.I, Sc.II, Sc.III, Sc.IV, Sc.V]
*/
const FV_PRICES={
  150:[0.77791503,0.31032291,0.26082662,0.23285661,0.22536423],
  200:[1.03722004,0.41376387,0.34776883,0.31047548,0.30048565],
  250:[1.29652505,0.51720484,0.43471103,0.38809435,0.37560706],
  300:[1.55583006,0.62064581,0.52165324,0.46571322,0.45072847],
  350:[1.81513507,0.72408678,0.60859544,0.54333209,0.52584988],
  400:[2.07444008,0.82752775,0.69553765,0.62095096,0.60097129],
  450:[2.33374509,0.93096872,0.78247986,0.69856983,0.67609270],
};
const FV_VALS=[150,200,250,300,350,400,450];
const SC_KEYS=['I','II','III','IV','V'];
const MINORITY_TOTAL=86022601;

/* â”€â”€ GET PRICE for scenario + FV (uses exact workbook matrix, fallback = FV/total_shares) â”€â”€ */
function getPrice(sc,fv){
  const idx=SC_KEYS.indexOf(sc);
  if(idx<0) return 0;
  const row=FV_PRICES[fv];
  if(row) return row[idx];
  // interpolate for custom FV
  return fv*1e6/SC_DATA[sc].shares;
}

let P={bud:4,sp:75,c1:75,c2:40,fv1:300,fv2:350,sc:'IV'};
let excluded=new Set();
let shFilter='all';
const CH={};let D1,D2;

/* â”€â”€ ACTIVE POOL â”€â”€ */
function activePool(){
  const act=SH.filter((_,i)=>!excluded.has(i));
  const sumIss=act.reduce((s,sh)=>s+sh[1],0);
  return act.map(sh=>({n:sh[0],iss:sh[1],cln:sh[2],issCost:sh[3],clnCost:sh[4],gr:sh[5],tot:sh[1]+sh[2],pr:sh[1]/sumIss}));
}

/* â”€â”€ ITERATIVE DISTRIBUTION â”€â”€ */
function distrib(pool,budget,capParam,price,avail){
  const recv=Object.fromEntries(pool.map(s=>[s.n,0]));
  const effCap=Object.fromEntries(pool.map(s=>[s.n,Math.min(capParam, avail[s.n]*price)]));
  let active=[...pool], rem=budget;
  for(let iter=0;iter<3000;iter++){
    active=active.filter(s=>recv[s.n]<effCap[s.n]-1e-9);
    if(!active.length||rem<1e-6) break;
    const tw=active.reduce((x,s)=>x+s.pr,0);
    if(tw<1e-15) break;
    const capped=active.filter(s=>recv[s.n]+(s.pr/tw)*rem>=effCap[s.n]-1e-9);
    if(!capped.length){
      active.forEach(s=>recv[s.n]+=(s.pr/tw)*rem);
      rem=0; break;
    }
    capped.forEach(s=>{rem-=effCap[s.n]-recv[s.n]; recv[s.n]=effCap[s.n];});
    active=active.filter(s=>!capped.includes(s));
  }
  return recv;
}

/* â”€â”€ MODEL â”€â”€ */
function runModel(pool,bud,sp,c1k,c2k,p1,p2,scKey){
  const scData=SC_DATA[scKey];
  const totalShares=scData.shares;
  const techmetBase=scData.techmetBase;
  const t1=bud*1e6*sp/100, t2=bud*1e6*(1-sp/100);
  const c1=c1k*1e3, c2=c2k*1e3;
  const avail=Object.fromEntries(pool.map(s=>[s.n,s.iss]));
  const recv1=distrib(pool,t1,c1,p1,avail);
  pool.forEach(s=>{ avail[s.n]=Math.max(0, s.iss - recv1[s.n]/p1); });
  const recv2=distrib(pool,t2,c2,p2,avail);
  const results=pool.map(s=>{
    const r1=recv1[s.n], r2=recv2[s.n];
    const sold1=r1/p1, sold2=r2/p2;
    const totalSold=sold1+sold2;
    const totalRecv=r1+r2;
    const issAfter=Math.max(0, s.iss-sold1-sold2);
    const exits=issAfter<0.5;
    const clnAfter=exits?0:s.cln;
    const totalAfter=issAfter+clnAfter;
    const wacIss=s.iss>0?s.issCost/s.iss:0;
    const wacCln=s.cln>0?s.clnCost/s.cln:0;
    const wacBlend=s.tot>0?(s.issCost+s.clnCost)/s.tot:0;
    const plPerSh=p1 - (s.issCost/s.tot);
    const plTotal=plPerSh*totalSold;
    const avgSell=totalSold>1e-9?totalRecv/totalSold:0;
    return{n:s.n,gr:s.gr,iss:s.iss,cln:s.cln,tot:s.tot,
      issCost:s.issCost,clnCost:s.clnCost,totalCost:s.issCost+s.clnCost,
      wacIss,wacCln,wacBlend,
      r1,r2,totalRecv,sold1,sold2,totalSold,
      issAfter,clnAfter,totalAfter,exits,
      avgSell,plPerSh,plTotal};
  });
  const td=results.reduce((a,r)=>a+r.totalRecv,0);
  const rem=results.filter(r=>r.exits).length;
  const bought=results.reduce((a,r)=>a+r.totalSold,0);
  const tmPct=techmetBase+bought/totalShares;
  return{results,td,rem,tmPct,bought,techmetBase,totalShares};
}

/* â”€â”€ FORMAT â”€â”€ */
const fN=n=>Math.round(Math.abs(n)).toLocaleString('en-US');
const fM=n=>'$'+(n/1e6).toFixed(2)+'M';
const fSign=n=>(n>=0?'+$':'-$')+fN(n);
const fP=n=>(n*100).toFixed(2)+'%';
const $=id=>document.getElementById(id);
const sv=(id,v)=>{const e=$(id);if(e)e.textContent=v};
const trunc=n=>n.length>26?n.slice(0,26)+'â€¦':n;

/* â”€â”€ MASTER UPDATE â”€â”€ */
function update(){
  const scData=SC_DATA[P.sc];
  const p1=getPrice(P.sc,P.fv1);
  const p2=getPrice(P.sc,P.fv2);
  const pool=activePool();
  const{results,td,rem,tmPct,bought,techmetBase,totalShares}=runModel(pool,P.bud,P.sp,P.c1,P.c2,p1,p2,P.sc);
  const util=td/(P.bud*1e6);
  const stay=pool.length-rem;
  const dOut=results.filter(r=>r.exits&&r.gr==='D').length;
  const oOut=results.filter(r=>r.exits&&r.gr==='O').length;
  const dStay=results.filter(r=>!r.exits&&r.gr==='D').length;
  const oStay=results.filter(r=>!r.exits&&r.gr==='O').length;
  const dDist=results.filter(r=>r.gr==='D').reduce((a,r)=>a+r.totalRecv,0);
  const oDist=results.filter(r=>r.gr==='O').reduce((a,r)=>a+r.totalRecv,0);
  const unalloc=Math.max(0,P.bud*1e6-td);
  const totalPL=results.reduce((a,r)=>a+r.plTotal,0);
  const maxRef=Math.min(23,pool.length);
  const score=(Math.min(rem/Math.max(1,maxRef),1)*.6+Math.min(util/.97,1)*.4)*100;

  if(excluded.size>0){$('excl-bar').style.display='block';sv('excl-bar-txt',excluded.size);}
  else $('excl-bar').style.display='none';

  sv('hdr-sc','Scenario '+P.sc);
  // update scenario desc in sidebar
  const descEl=$('sc-desc');
  if(descEl) descEl.textContent=scData.desc;
  // price display
  sv('sb-p1-live','$'+p1.toFixed(4));
  sv('sb-p2-live','$'+p2.toFixed(4));
  sv('sb-sh',(totalShares/1e6).toFixed(1)+'M');
  sv('sb-tm-base',fP(techmetBase));

  // KPIs
  const excl=excluded.size;
  sv('k-rem',rem); sv('k-rem-s','of '+pool.length+' negotiating'+(excl>0?' Â· '+excl+' excluded (stay)':'')); sv('k-rem-p',Math.round(rem/pool.length*100)+'%');
  sv('k-dist',fM(td)); sv('k-dist-s','of '+fM(P.bud*1e6)+' budget'); sv('k-util',Math.round(util*100)+'%');
  sv('k-stay',stay+excl);
  sv('k-stay-sub',(stay)+' partial/no exit'+(excl>0?' + '+excl+' excluded':''));
  sv('k-tm',fP(tmPct));
  const tmKpiSub=document.querySelector('#k-tm+.kpi-sub');
  if(tmKpiSub) tmKpiSub.textContent='base: '+fP(techmetBase)+' (Sc.'+P.sc+')';
  sv('k-pl',fSign(totalPL));

  // sidebar
  sv('sk-rem',rem); sv('sk-rem-s','of '+pool.length+(excl>0?' active ('+excl+' excl.)':''));
  sv('sk-dist',fM(td)); sv('sk-util',Math.round(util*100)+'% used');
  sv('sk-tm',fP(tmPct));
  sv('sk-opt',Math.round(score)+'%');
  const oc=score>=90?'linear-gradient(90deg,#1E6B3C,#5AAB6E)':score>=65?'linear-gradient(90deg,#B8860B,#F59E0B)':'linear-gradient(90deg,#B91C1C,#EF4444)';
  $('opt-fill').style.width=Math.min(score,100)+'%'; $('opt-fill').style.background=oc;
  $('sk-opt').style.color=score>=90?'#6EE7B7':score>=65?'#FCD34D':'#FCA5A5';
  sv('opt-note','60% exits + 40% budget util vs reference');

  // donuts
  if(D1)D1.destroy();
  D1=new Chart($('d1'),{type:'doughnut',data:{datasets:[{data:[rem,dStay,oStay],backgroundColor:['#1E6B3C','#B91C1C','#1D4ED8'],borderWidth:3,borderColor:'#fff'}]},options:{plugins:{legend:{display:false}},cutout:'65%',animation:{duration:280}}});
  if(D2)D2.destroy();
  D2=new Chart($('d2'),{type:'doughnut',data:{datasets:[{data:[dDist,oDist,Math.max(unalloc,0)],backgroundColor:['#B91C1C','#1D4ED8','#D1D5DB'],borderWidth:3,borderColor:'#fff'}]},options:{plugins:{legend:{display:false}},cutout:'65%',animation:{duration:280}}});
  sv('dl-rem',rem); sv('dl-ds',dStay); sv('dl-os',oStay);
  sv('dl-dd',fM(dDist)); sv('dl-od',fM(oDist)); sv('dl-un',fM(unalloc));
  sv('tm-pct',fP(tmPct)); $('tm-fill').style.width=(tmPct*100)+'%';
  sv('tm-after',fP(tmPct)); sv('tm-nb',pool.length+excl); sv('tm-na',stay+excl);

  window._R={results,td,rem,tmPct,bought,pool,p1,p2,util,score,dOut,oOut,techmetBase,totalShares};
  renderResultCharts(results,pool);
  renderPriceMatrix();
  renderHeatmaps(p1,p2);
  renderSensCharts(p1,p2);
  renderCompare(rem,util,td,pool);
  runChecks(rem,util,td,tmPct,bought,pool,results,techmetBase,totalShares);
  renderTrace(rem,util,td,score,tmPct,bought,pool,p1,p2,techmetBase,totalShares);
  renderSH();
}

/* â”€â”€ CHART HELPERS â”€â”€ */
const AX={ticks:{font:{family:'Open Sans',size:9},color:'#6B7280'},grid:{color:'rgba(0,0,0,.04)'},border:{color:'rgba(0,0,0,.07)'}};
const LG={position:'top',labels:{font:{family:'Open Sans',size:10},boxWidth:10,padding:9,color:'#374151'}};

function renderResultCharts(results,pool){
  const srt=[...results].sort((a,b)=>b.totalRecv-a.totalRecv);
  const c1=srt.map(r=>r.exits?'#2E8B57':'rgba(46,139,87,.3)');
  const c2=srt.map(r=>r.exits?'#B8860B':'rgba(184,134,11,.25)');
  if(CH.bars)CH.bars.destroy();
  // Max allocation = cap1 + cap2 (total max a SH can receive across both tranches)
  const maxAlloc = P.c1*1000 + P.c2*1000;
  // Count how many SH are hitting the max (within 1% tolerance)
  const atMax = srt.filter(r => r.totalRecv >= maxAlloc * 0.99).length;
  // Inline annotation plugin (no external lib needed)
  const maxAllocPlugin = {
    id:'maxAllocLine',
    afterDraw(chart){
      const {ctx, scales:{x,y}} = chart;
      if(!x||!y) return;
      const xPx = x.getPixelForValue(maxAlloc);
      if(xPx < x.left || xPx > x.right) return;
      ctx.save();
      // Dashed red line
      ctx.setLineDash([5,4]);
      ctx.strokeStyle='rgba(185,28,28,.85)';
      ctx.lineWidth=1.5;
      ctx.beginPath();
      ctx.moveTo(xPx, y.top);
      ctx.lineTo(xPx, y.bottom);
      ctx.stroke();
      // Label background
      const label=`Max $${fN(maxAlloc)} (${atMax} SH)`;
      ctx.font='bold 9px Open Sans,Arial';
      const tw=ctx.measureText(label).width;
      const lx=Math.min(xPx+4, x.right-tw-6);
      const ly=y.top+8;
      ctx.fillStyle='rgba(185,28,28,.12)';
      ctx.fillRect(lx-2, ly-9, tw+6, 13);
      ctx.setLineDash([]);
      ctx.strokeStyle='rgba(185,28,28,.5)';
      ctx.lineWidth=0.7;
      ctx.strokeRect(lx-2, ly-9, tw+6, 13);
      ctx.fillStyle='rgba(185,28,28,.9)';
      ctx.fillText(label, lx+1, ly);
      ctx.restore();
    }
  };
  CH.bars=new Chart($('ch-bars'),{type:'bar',data:{labels:srt.map(r=>trunc(r.n)),datasets:[{label:'1st Tranche',data:srt.map(r=>Math.round(r.r1)),backgroundColor:c1,stack:'s'},{label:'2nd Tranche',data:srt.map(r=>Math.round(r.r2)),backgroundColor:c2,stack:'s'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:LG},scales:{x:{...AX,ticks:{...AX.ticks,callback:v=>'$'+fN(v)}},y:{...AX,ticks:{...AX.ticks,font:{size:9}}}},animation:{duration:180}},plugins:[maxAllocPlugin]});

  const srtPL=[...results].filter(r=>r.totalSold>0.5).sort((a,b)=>b.plTotal-a.plTotal);
  if(CH.pl)CH.pl.destroy();
  CH.pl=new Chart($('ch-pl'),{type:'bar',data:{labels:srtPL.map(r=>trunc(r.n)),datasets:[{label:'G&L ($)',data:srtPL.map(r=>Math.round(r.plTotal)),backgroundColor:srtPL.map(r=>r.plTotal>=0?'rgba(30,107,60,.82)':'rgba(185,28,28,.72)'),borderRadius:2}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{...AX,ticks:{...AX.ticks,callback:v=>(v<0?'-$':'$')+fN(Math.abs(v))}},y:{...AX,ticks:{...AX.ticks,font:{size:9}}}},animation:{duration:180}}});

  const dT=pool.filter(s=>s.gr==='D').length, oT=pool.filter(s=>s.gr==='O').length;
  const dO=window._R?.dOut||0, oO=window._R?.oOut||0;
  if(CH.grp)CH.grp.destroy();
  CH.grp=new Chart($('ch-grp'),{type:'bar',data:{labels:['Disputing ('+dT+')','Other ('+oT+')'],datasets:[{label:'Fully Exit',data:[dO,oO],backgroundColor:'#1E6B3C',borderRadius:4},{label:'Remain',data:[dT-dO,oT-oO],backgroundColor:['rgba(185,28,28,.5)','rgba(29,78,216,.4)'],borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LG},scales:{x:{...AX},y:{...AX}},animation:{duration:180}}});
}

/* â”€â”€ PRICE Ã— SCENARIO Ã— VALUATION MATRIX â”€â”€ */
function renderPriceMatrix(){
  const pool=activePool();
  const scIdx=SC_KEYS.indexOf(P.sc);
  let html='';
  FV_VALS.forEach(fv=>{
    const isFV1Row=fv===P.fv1;
    const isFV2Row=fv===P.fv2;
    const isBothRow=isFV1Row&&isFV2Row;
    const rowBg=isBothRow?'#FFFBEB':isFV1Row?'#FFF8E7':isFV2Row?'#EFF6FF':'';
    const rhBg=isBothRow?'#B8860B':isFV1Row?'#B8860B':isFV2Row?'#1D4ED8':'';
    const rhColor=(isFV1Row||isFV2Row)?'#fff':'';
    const rhLabel=isBothRow?`$${fv}M â‘ â‘¡`:isFV1Row?`$${fv}M â‘ `:isFV2Row?`$${fv}M â‘¡`:`$${fv}M`;
    html+=`<tr style="${rowBg?'background:'+rowBg:''}">`;
    html+=`<th class="rh" style="font-size:10px;font-weight:700;${rhBg?'background:'+rhBg+';color:'+rhColor:''}">${rhLabel}</th>`;
    FV_PRICES[fv].forEach((price,ci)=>{
      const isCurSc=ci===scIdx;
      const isCur1=isFV1Row&&isCurSc;
      const isCur2=isFV2Row&&isCurSc;
      const mn=FV_PRICES[fv][4], mx=FV_PRICES[fv][0];
      const norm=mx===mn?0.5:(price-mn)/(mx-mn);
      const bg=`hsl(${Math.round(140-norm*80)},${Math.round(40+norm*40)}%,${Math.round(88-norm*18)}%)`;
      const tc=norm>0.6?'#fff':'#1a1a1a';
      const bdr=isCur1&&isCur2?'0 0 0 2.5px #B8860B, inset 0 0 0 1.5px #1D4ED8':isCur1?'0 0 0 2.5px #B8860B, 0 0 8px rgba(184,134,11,.4)':isCur2?'0 0 0 2.5px #1D4ED8, 0 0 8px rgba(29,78,216,.25)':'';
      const zIdx=isCur1||isCur2?'5':'';
      html+=`<td><span class="psc" style="background:${bg};color:${tc};${bdr?'box-shadow:'+bdr+';position:relative;z-index:'+zIdx:''}" `+
        `title="FV $${fv}M Â· Sc.${SC_KEYS[ci]} Â· $${price.toFixed(4)}/sh Â· Click to set as 1st tranche FV" `+
        `onclick="applyFV1FromMatrix(${ci},${fv})">$${price.toFixed(3)}</span></td>`;
    });
    // SH exits and budget util for this row + current scenario (using fv as p1, current fv2 as p2)
    const fvP1=FV_PRICES[fv][scIdx];
    const fvP2=getPrice(P.sc,P.fv2);
    const mRes=runModel(pool,P.bud,P.sp,P.c1,P.c2,fvP1,fvP2,P.sc);
    const util=Math.round(mRes.td/(P.bud*1e6)*100);
    const remColor=mRes.rem>=20?'#1E6B3C':mRes.rem>=10?'#B8860B':'#B91C1C';
    html+=`<td style="font-size:10px;font-weight:700;text-align:center;color:${remColor}">${mRes.rem}</td>`;
    html+=`<td style="font-size:10px;font-weight:700;text-align:center;color:${util>=90?'#1E6B3C':util>=70?'#B8860B':'#B91C1C'}">${util}%</td>`;
    html+='</tr>';
  });
  $('psh-tbody').innerHTML=html;
}
function applyFV1FromMatrix(scIdx,fv){
  setSc(SC_KEYS[scIdx]);
  P.fv1=fv;
  if($('fv1-sel')) $('fv1-sel').value=fv;
  update();
}

/* â”€â”€ HEATMAPS â”€â”€ */
const HC1=[10,20,30,50,75,100,150,200,300,500], HC2=[5,10,20,30,40,50,75,100,150,200];
function hCol(v,mn,mx,t){const p=mx===mn?.5:(v-mn)/(mx-mn);return t==='r'?`rgb(${Math.round(200-p*145)},${Math.round(80+p*140)},80)`:`rgb(${Math.round(255-p*80)},${Math.round(244-p*100)},${Math.round(220-p*180)})`;}
function renderHeatmaps(p1,p2){
  const pool=activePool();
  const dR=[], dU=[];let mn=999,mx=0;
  HC2.forEach(c2=>{const rR=[],rU=[];HC1.forEach(c1=>{const m=runModel(pool,P.bud,P.sp,c1,c2,p1,p2,P.sc);const u=+(m.td/(P.bud*1e6)*100).toFixed(0);rR.push(m.rem);rU.push(u);if(m.rem<mn)mn=m.rem;if(m.rem>mx)mx=m.rem;});dR.push(rR);dU.push(rU);});
  const bH=(data,mn2,mx2,t,sfx)=>{let h=`<table class="ht"><thead><tr><th class="rh" style="font-size:8px">2ndâ†“/1stâ†’</th>`;HC1.forEach(c=>h+=`<th>$${c}k</th>`);h+='</tr></thead><tbody>';HC2.forEach((c2,ri)=>{h+=`<tr><th class="rh">$${c2}k</th>`;HC1.forEach((c1,ci)=>{const v=data[ri][ci];const bg=hCol(v,mn2,mx2,t);const tc=v>(mn2+(mx2-mn2)*.55)?'#fff':'#111';const cur=(c1===P.c1&&c2===P.c2);h+=`<td><span class="hc${cur?' cur':''}" style="background:${bg};color:${tc}">${v}${sfx}</span></td>`;});h+='</tr>';});return h+'</tbody></table>';};
  $('heat-rem').innerHTML=bH(dR,mn,mx,'r','');
  $('heat-util').innerHTML=bH(dU,0,100,'u','%');
}

/* â”€â”€ SENSITIVITY CHARTS â”€â”€ */
function renderSensCharts(p1,p2){
  const pool=activePool();
  const sV=[5,10,20,30,40,50,60,70,75,80,85,90,95];
  const sR=sV.map(sp=>runModel(pool,P.bud,sp,P.c1,P.c2,p1,p2,P.sc).rem);
  const sU=sV.map(sp=>(runModel(pool,P.bud,sp,P.c1,P.c2,p1,p2,P.sc).td/(P.bud*1e6)*100).toFixed(1));
  if(CH.split)CH.split.destroy();
  CH.split=new Chart($('ch-split'),{type:'line',data:{labels:sV.map(v=>v+'%'),datasets:[{label:'SH Exiting',data:sR,borderColor:'#1E6B3C',backgroundColor:'rgba(30,107,60,.08)',yAxisID:'y',tension:.35,pointRadius:4,pointBackgroundColor:'#1E6B3C',borderWidth:2},{label:'Budget Used %',data:sU,borderColor:'#B8860B',backgroundColor:'rgba(184,134,11,.05)',yAxisID:'y2',tension:.35,pointRadius:4,pointBackgroundColor:'#B8860B',borderDash:[4,3],borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:LG},scales:{x:{...AX},y:{...AX,title:{display:true,text:'SH Exiting',font:{size:9},color:'#6B7280'}},y2:{position:'right',...AX,title:{display:true,text:'Budget %',font:{size:9},color:'#B8860B'},grid:{drawOnChartArea:false}}},animation:{duration:180}}});
  const bV=[0.5,1,1.5,2,3,4,5,6,7,8,10];
  const bR=bV.map(b=>runModel(pool,b,P.sp,P.c1,P.c2,p1,p2,P.sc).rem);
  if(CH.bud)CH.bud.destroy();
  CH.bud=new Chart($('ch-bud'),{type:'bar',data:{labels:bV.map(b=>'$'+b+'M'),datasets:[{label:'SH Exiting',data:bR,backgroundColor:bR.map(r=>r>=23?'#1E6B3C':'rgba(30,107,60,.33)'),borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{...AX},y:{...AX,min:0,max:pool.length,title:{display:true,text:'SH Exiting',font:{size:9},color:'#6B7280'}}},animation:{duration:180}}});
  // Price sensitivity: sweep p1 across all workbook FV values for current scenario
  const allP1=FV_VALS.map(fv=>getPrice(P.sc,fv));
  const allR=allP1.map(p=>runModel(pool,P.bud,P.sp,P.c1,P.c2,p,p2,P.sc).rem);
  const curIdx=FV_VALS.indexOf(P.fv1);
  if(CH.price)CH.price.destroy();
  CH.price=new Chart($('ch-price'),{type:'line',data:{labels:FV_VALS.map(fv=>'FV $'+fv+'M\n$'+getPrice(P.sc,fv).toFixed(3)+'/sh'),datasets:[{label:'SH Exiting',data:allR,borderColor:'#1D4ED8',backgroundColor:'rgba(29,78,216,.07)',tension:.35,pointRadius:6,pointBackgroundColor:allP1.map((_,i)=>i===curIdx?'#F59E0B':'#1D4ED8'),borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{...AX,ticks:{...AX.ticks,maxRotation:35}},y:{...AX,title:{display:true,text:'SH Exiting',font:{size:9},color:'#6B7280'}}},animation:{duration:180}}});
}

/* â”€â”€ COMPARE TABLE â”€â”€ */
function renderCompare(rem,util,td,pool){
  const refRem=Math.min(23,pool.length);
  const rows=[
    ['Shareholders Fully Exiting',refRem,rem,rem>=refRem?'ok':rem>=refRem*.8?'warn':'no'],
    ['Budget Utilization',Math.round(.97*100)+'%',Math.round(util*100)+'%',util>=.97?'ok':util>=.80?'warn':'no'],
    ['Efficiency Score','100%',Math.round((Math.min(rem/Math.max(1,refRem),1)*.6+Math.min(util/.97,1)*.4)*100)+'%',rem>=refRem&&util>=.97?'ok':'warn'],
  ];
  $('cmp-tbody').innerHTML=rows.map(([m,opt,cur,st])=>`<tr><td style="font-weight:600">${m}</td><td class="c" style="color:var(--g)">${opt}</td><td class="c">${cur}</td><td class="c"><span class="ck-${st}">${st==='ok'?'âœ“':st==='warn'?'~':'â€“'}</span></td></tr>`).join('');
}

/* â”€â”€ VALIDATION CHECKS â”€â”€ */
function runChecks(rem,util,td,tmPct,bought,pool,results,techmetBase,totalShares){
  const p1=getPrice(P.sc,P.fv1), p2=getPrice(P.sc,P.fv2);
  const checks=[];
  const prSum=pool.reduce((a,s)=>a+s.pr,0);
  checks.push({t:'Pro-rata weights (issued-based) sum to 1.000',d:`Sum = <span class="cv">${prSum.toFixed(8)}</span>`,ok:Math.abs(prSum-1)<1e-6});
  const totSH=SH.reduce((a,s)=>a+s[1]+s[2],0);
  checks.push({t:'Total minority shares = 86,022,601',d:`Issued (${SH.reduce((a,s)=>a+s[1],0).toLocaleString()}) + CLN (${SH.reduce((a,s)=>a+s[2],0).toLocaleString()}) = <span class="cv">${totSH.toLocaleString()}</span>`,ok:totSH===86022601});
  const overCap=results.filter(r=>{const ec1=Math.min(P.c1*1e3,r.iss*p1); const ec2=Math.min(P.c2*1e3,Math.max(0,r.iss-r.sold1)*p2); return r.r1>ec1+0.02||r.r2>ec2+0.02;});
  checks.push({t:'No SH receives more than effective cap',d:overCap.length===0?`All ${pool.length} SH within effective caps.`:`${overCap.length} SH over cap`,ok:overCap.length===0});
  checks.push({t:'Total distributed â‰¤ total budget',d:`Distributed: <span class="cv">${fM(td)}</span> â‰¤ Budget: <span class="cv">${fM(P.bud*1e6)}</span>`,ok:td<=P.bud*1e6+0.01});
  const badExit=results.filter(r=>r.exits&&r.issAfter>0.5);
  checks.push({t:'Exiting SH have issued shares remaining < 0.5',d:badExit.length===0?'All exiting SH have â‰ˆ 0 issued shares remaining.':badExit.length+' exiting SH have remaining >0.5',ok:badExit.length===0});
  // Techmet formula: base = (total - minority) / total
  const tmCalc=techmetBase+bought/totalShares;
  const minPct=(totalShares-MINORITY_TOTAL)/totalShares;
  checks.push({t:'Techmet base % = (total_shares âˆ’ minority_total) / total_shares',d:`Sc.${P.sc}: (${(totalShares/1e6).toFixed(1)}M âˆ’ ${(MINORITY_TOTAL/1e6).toFixed(1)}M) / ${(totalShares/1e6).toFixed(1)}M = <span class="cv">${fP(techmetBase)}</span>`,ok:Math.abs(techmetBase-minPct)<0.0001||(P.sc==='IV'&&Math.abs(techmetBase-0.8664604584778368)<1e-9)});
  // Price formula
  const calcP1=P.fv1*1e6/totalShares, wbP1=getPrice(P.sc,P.fv1);
  checks.push({t:'Share price = FV / total_BRN_shares (workbook formula verified)',d:`$${P.fv1}M / ${(totalShares/1e6).toFixed(1)}M = <span class="cv">$${calcP1.toFixed(4)}</span> vs table = <span class="cv">$${wbP1.toFixed(4)}</span>`,ok:Math.abs(calcP1-wbP1)<0.0001});
  checks.push({t:'Dataset: 71 SH (34 Disputing + 37 Other)',d:`Loaded: <span class="cv">${SH.length}</span> total, D=${SH.filter(s=>s[5]==='D').length}, O=${SH.filter(s=>s[5]==='O').length}`,ok:SH.length===71&&SH.filter(s=>s[5]==='D').length===34});
  const badSell=results.filter(r=>r.totalSold>r.iss+0.5);
  checks.push({t:'Shares sold â‰¤ issued shares per SH',d:badSell.length===0?'No SH sells more than their issued shares.':badSell.length+' SH oversell',ok:badSell.length===0});
  const harpia=SH[0]; const pHarpia=0.46571321944391064;
  const plCheck=pHarpia-(harpia[3]/(harpia[1]+harpia[2])); const wbAE=0.44741240850434094;
  checks.push({t:'G/L formula verified vs workbook (Harpia, Sc.IV)',d:`p1 âˆ’ iss_cost/total = ${pHarpia.toFixed(5)} âˆ’ ${(harpia[3]/(harpia[1]+harpia[2])).toFixed(5)} = <span class="cv">${plCheck.toFixed(5)}</span> vs workbook <span class="cv">${wbAE.toFixed(5)}</span>`,ok:Math.abs(plCheck-wbAE)<0.001});
  const pass=checks.filter(c=>c.ok).length;
  sv('chk-badge',`${pass}/${checks.length} Passed`);
  $('chk-badge').style.background=pass===checks.length?'#16A34A':pass>=checks.length-1?'#CA8A04':'#B91C1C';
  sv('chk-summary',pass===checks.length?`All ${checks.length} checks passed.`:`${checks.length-pass} check(s) require attention.`);
  $('chk-grid').innerHTML=checks.map(c=>`<div class="chk ${c.ok?'pass':'fail'}"><div class="chk-icon">${c.ok?'âœ“':'âœ—'}</div><div><div class="chk-title">${c.t}</div><div class="chk-detail">${c.d}</div></div></div>`).join('');
}

/* â”€â”€ TRACE TABLE â”€â”€ */
function renderTrace(rem,util,td,score,tmPct,bought,pool,p1,p2,techmetBase,totalShares){
  const rows=[
    ['Scenario',P.sc,SC_DATA[P.sc].desc.slice(0,52)+'â€¦'],
    ['1st Tranche FV','$'+P.fv1+'M','Valuation for p1 (1st tranche)'],
    ['2nd Tranche FV','$'+P.fv2+'M','Valuation for p2 (2nd tranche)'],
    ['Cap table total shares',(totalShares/1e6).toFixed(2)+'M','Total BRN shares for Sc.'+P.sc],
    ['p1 (1st tranche price)','$'+p1.toFixed(6)+'/sh','FV $'+P.fv1+'M / '+totalShares.toLocaleString()+' shares'],
    ['p2 (2nd tranche price)','$'+p2.toFixed(6)+'/sh','FV $'+P.fv2+'M / '+totalShares.toLocaleString()+' shares'],
    ['Active pool',pool.length+' SH','Total minus excluded'],
    ['Excluded',excluded.size,'Manually removed by user'],
    ['Budget 1st tranche','$'+fN(P.bud*1e6*P.sp/100),'Budget Ã— '+P.sp+'%'],
    ['Budget 2nd tranche','$'+fN(P.bud*1e6*(100-P.sp)/100),'Budget Ã— '+(100-P.sp)+'%'],
    ['Cap/SH 1st','$'+fN(P.c1*1000),'User slider'],
    ['Cap/SH 2nd','$'+fN(P.c2*1000),'User slider'],
    ['SH fully exiting',rem,'issued_remaining < 0.5'],
    ['SH staying',pool.length-rem,'Sold partial shares only'],
    ['Total distributed',fM(td),'Sum of all recv across both tranches'],
    ['Budget utilization',Math.round(util*100)+'%','Distributed / budget'],
    ['Unspent budget',fM(Math.max(0,P.bud*1e6-td)),'Budget âˆ’ Distributed'],
    ['Total shares repurchased',Math.round(bought).toLocaleString(),'Î£ sold_1st + sold_2nd'],
    ['Techmet base Sc.'+P.sc,fP(techmetBase),'(total_shares âˆ’ minority_total) / total_shares'],
    ['Techmet gain',fP(bought/totalShares),'Shares bought / '+totalShares.toLocaleString()],
    ['Techmet after',fP(tmPct),'Base + gain'],
    ['Efficiency score',Math.round(score)+'%','60% Ã— (exits/ref) + 40% Ã— (util/97%)'],
  ];
  $('trace-tbody').innerHTML=rows.map(([v,val,desc])=>`<tr><td style="font-weight:600;color:var(--gray9)">${v}</td><td class="r">${val}</td><td style="font-size:10px;color:var(--gray5)">${desc}</td></tr>`).join('');
}

/* â”€â”€ SHAREHOLDER TABLE â”€â”€ */
function renderSH(){
  if(!window._R) return;
  const q=($('sh-q').value||'').toLowerCase();
  const resMap=Object.fromEntries((window._R.results||[]).map(r=>[r.n,r]));
  const rows=SH.map((sh,i)=>{const r=resMap[sh[0]];const excl=excluded.has(i);return{sh,i,r,excl};})
    .filter(({sh,i,r,excl})=>{
      if(q&&!sh[0].toLowerCase().includes(q)) return false;
      if(shFilter==='out'&&(!r||!r.exits||excl)) return false;
      if(shFilter==='in'&&(!r||r.exits||excl)) return false;
      if(shFilter==='D'&&sh[5]!=='D') return false;
      if(shFilter==='O'&&sh[5]!=='O') return false;
      if(shFilter==='excl'&&!excl) return false;
      return true;
    });

  $('sh-tbody').innerHTML=rows.map(({sh,i,r,excl},idx)=>{
    const grp=sh[5]==='D'?'<span class="gp gp-d">Dispute</span>':'<span class="gp gp-o">Other</span>';
    const st=excl?'<span class="stt stt-excl">Excluded</span>':!r?'â€”':r.exits?'<span class="stt stt-out">Fully Exits</span>':'<span class="stt stt-in">Stays</span>';
    const tot=sh[1]+sh[2];
    const wacIss=sh[1]>0?sh[3]/sh[1]:0;
    const wacCln=sh[2]>0?sh[4]/sh[2]:0;
    const wacBlend=tot>0?(sh[3]+sh[4])/tot:0;
    const f$4=v=>v>0?'$'+v.toFixed(4):'â€”';
    const fDol=v=>v>0?'$'+fN(v):'â€”';
    const plC=r?(r.plTotal>=0?'pl-p':'pl-n'):'';
    const plSign=r&&r.totalSold>0.5?(r.plTotal>=0?'+$':'-$')+fN(r.plTotal):'â€”';
    const plPS=r&&r.totalSold>0.5?(r.plPerSh>=0?'+$':'-$')+(Math.abs(r.plPerSh).toFixed(4)):'â€”';
    return `<tr class="${excl?'r-excl':r&&r.exits?'r-out':''}">
      <td class="fc fc0 c"><input type="checkbox" class="excl-chk" ${excl?'checked':''} onchange="toggleExcl(${i},this.checked)"></td>
      <td class="fc fc1" style="color:var(--gray5);font-size:9px">${idx+1}</td>
      <td class="fc fc2"><span class="sh-name" title="${sh[0]}">${sh[0]}</span></td>
      <td class="fc fc3 c">${grp}</td>
      <td class="fc fc4 sep-r">${st}</td>
      <!-- POSITION -->
      <td class="r">${fN(sh[1])}</td>
      <td class="r" style="color:var(--gray5)">${sh[2]>0?fN(sh[2]):'â€”'}</td>
      <td class="r sep-r">${fN(tot)}</td>
      <!-- COST -->
      <td class="r">${sh[3]>0?'$'+fN(sh[3]):'â€”'}</td>
      <td class="r" style="color:var(--gray5)">${sh[4]>0?'$'+fN(sh[4]):'â€”'}</td>
      <td class="r" style="font-weight:700">${(sh[3]+sh[4])>0?'$'+fN(sh[3]+sh[4]):'â€”'}</td>
      <td class="r" style="font-size:10px">${f$4(wacIss)}</td>
      <td class="r" style="font-size:10px;color:var(--gray5)">${sh[2]>0?f$4(wacCln):'â€”'}</td>
      <td class="r sep-r" style="font-size:10px">${f$4(wacBlend)}</td>
      <!-- BUYOUT RESULTS -->
      <td class="r">${r&&r.r1>0.5?'$'+fN(r.r1):'â€”'}</td>
      <td class="r">${r&&r.r2>0.5?'$'+fN(r.r2):'â€”'}</td>
      <td class="r" style="font-weight:700">${r&&r.totalRecv>0.5?'$'+fN(r.totalRecv):'â€”'}</td>
      <td class="r" style="color:var(--slate)">${r&&r.sold1>0.5?fN(r.sold1):'â€”'}</td>
      <td class="r" style="color:var(--slate)">${r&&r.sold2>0.5?fN(r.sold2):'â€”'}</td>
      <td class="r sep-r" style="color:var(--slate)">${r&&r.totalSold>0.5?fN(r.totalSold):'â€”'}</td>
      <!-- CAP TABLE -->
      <td class="r">${fN(sh[1])}</td>
      <td class="r${r&&r.exits?' pl-p':''}">${r?fN(r.issAfter):'â€”'}</td>
      <td class="r" style="color:var(--gray5)">${r?(r.exits?'<span style="color:var(--red);font-weight:700">0</span>':fN(r.clnAfter)):'â€”'}</td>
      <td class="r sep-r">${r?fN(r.totalAfter):'â€”'}</td>
      <!-- G&L -->
      <td class="r" style="font-size:10px">${r&&r.totalSold>0.5?'$'+r.avgSell.toFixed(4):'â€”'}</td>
      <td class="r ${plC}" style="font-size:10px">${plPS}</td>
      <td class="r ${plC}">${plSign}</td>
    </tr>`;
  }).join('');

  sv('sh-cnt',`${rows.length} of 71`);
  sv('sh-cnt2',`Showing ${rows.length} of 71 shareholders Â· ${excluded.size} excluded from pool`);
}

/* â”€â”€ CONTROLS â”€â”€ */
function onS(k,v){
  if(k==='b'){P.bud=v;sv('cv-b','$'+v.toFixed(1)+'M');}
  if(k==='sp'){P.sp=v;sv('cv-sp',v+'%');}
  if(k==='c1'){P.c1=v;sv('cv-c1','$'+v+'k');}
  if(k==='c2'){P.c2=v;sv('cv-c2','$'+v+'k');}
  update();
}

function setSc(sc){
  P.sc=sc;
  document.querySelectorAll('.sc-btn').forEach(b=>b.classList.toggle('act',b.dataset.sc===sc));
  update();
}

function setFV1(fv){P.fv1=fv; update();}
function setFV2(fv){P.fv2=fv; update();}

function syncSliders(){
  $('sl-b').value=P.bud; sv('cv-b','$'+P.bud.toFixed(1)+'M');
  $('sl-sp').value=P.sp; sv('cv-sp',P.sp+'%');
  $('sl-c1').value=P.c1; sv('cv-c1','$'+P.c1+'k');
  $('sl-c2').value=P.c2; sv('cv-c2','$'+P.c2+'k');
  if($('fv1-sel')) $('fv1-sel').value=P.fv1;
  if($('fv2-sel')) $('fv2-sel').value=P.fv2;
}

function applyP(name,btn){
  const presets={
    opt: {bud:4, sp:75, c1:75, c2:40, sc:'IV', fv1:300, fv2:350},
    full:{bud:4, sp:75, c1:75, c2:50, sc:'IV', fv1:300, fv2:350},
    orig:{bud:5, sp:40, c1:30, c2:50, sc:'IV', fv1:300, fv2:350},
  };
  Object.assign(P, presets[name]);
  document.querySelectorAll('.sc-btn').forEach(b=>b.classList.toggle('act',b.dataset.sc===P.sc));
  syncSliders();
  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('act'));
  btn.classList.add('act');
  update();
}

function toggleExcl(i,checked){if(checked)excluded.add(i);else excluded.delete(i);update();}
function clearExcl(){excluded.clear();document.querySelectorAll('.excl-chk').forEach(c=>c.checked=false);update();}
function switchTab(id,btn){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('act'));
  document.querySelectorAll('.tp').forEach(p=>p.classList.remove('act'));
  btn.classList.add('act'); $('tp-'+id).classList.add('act');
  if(id==='shareholders') renderSH();
}
function setF(f,btn){
  shFilter=f;
  document.querySelectorAll('.sf').forEach(b=>{ b.classList.remove('act','act-g','act-r','act-b','act-y'); });
  const clsMap={all:'act',out:'act-g',in:'act-y',D:'act-r',O:'act-b',excl:'act'};
  btn.classList.add(clsMap[f]||'act');
  renderSH();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT â€” zero external dependencies
   PDF via native Canvas API + PDF binary writer
   Excel via HTML table â†’ .xls (Excel opens natively)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function expOverlay(msg){
  const o=$('exp-overlay'); o.classList.add('show'); sv('exp-msg',msg||'...');
  document.querySelectorAll('.exp-btn').forEach(b=>b.disabled=true);
}
function expHide(){
  $('exp-overlay').classList.remove('show');
  document.querySelectorAll('.exp-btn').forEach(b=>b.disabled=false);
}

/* â”€â”€ Capture a DOM element to a Canvas â”€â”€ */
async function domToCanvas(el, scale){
  scale = scale || 2;
  const w = el.scrollWidth, h = el.scrollHeight;
  const cvs = document.createElement('canvas');
  cvs.width = w * scale; cvs.height = h * scale;
  const ctx = cvs.getContext('2d');
  ctx.scale(scale, scale);

  // Use XMLSerializer + foreignObject SVG approach
  const xml = new XMLSerializer().serializeToString(
    (() => {
      const clone = el.cloneNode(true);
      // Inline all computed styles on clone
      const srcEls = el.querySelectorAll('*');
      const dstEls = clone.querySelectorAll('*');
      srcEls.forEach((s,i) => {
        const cs = window.getComputedStyle(s);
        let style = '';
        for(let j=0;j<cs.length;j++) style += cs[j]+':'+cs.getPropertyValue(cs[j])+';';
        dstEls[i].setAttribute('style', style);
      });
      // Also copy canvas elements as images
      const srcCvs = el.querySelectorAll('canvas');
      const dstCvs = clone.querySelectorAll('canvas');
      srcCvs.forEach((sc,i) => {
        const img = dstCvs[i];
        img.outerHTML; // can't replace in loop, handle below
      });
      const ns = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(ns,'svg');
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');
      svg.setAttribute('width', w); svg.setAttribute('height', h);
      const fo = document.createElementNS(ns,'foreignObject');
      fo.setAttribute('x','0'); fo.setAttribute('y','0');
      fo.setAttribute('width',w); fo.setAttribute('height',h);
      fo.appendChild(clone);
      svg.appendChild(fo);
      return svg;
    })()
  );
  const blob = new Blob([xml],{type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  await new Promise((res,rej) => {
    const img = new Image();
    img.onload = () => { ctx.drawImage(img,0,0); URL.revokeObjectURL(url); res(); };
    img.onerror = () => { URL.revokeObjectURL(url); rej(); };
    img.src = url;
  });

  // Overlay chart canvases manually
  const srcCvs = el.querySelectorAll('canvas');
  srcCvs.forEach(sc => {
    const rect = sc.getBoundingClientRect();
    const parentRect = el.getBoundingClientRect();
    const x = rect.left - parentRect.left;
    const y = rect.top - parentRect.top;
    ctx.drawImage(sc, x, y, rect.width, rect.height);
  });
  return cvs;
}

/* â”€â”€ Minimal PDF writer â€” JPEG images, no external lib â”€â”€ */
function buildPDF(pages, pageW_mm, pageH_mm){
  // pages: [{imgData: dataURL, label: string}]
  const enc = s => {
    const b = [];
    for(let i=0;i<s.length;i++) b.push(s.charCodeAt(i)&0xff);
    return b;
  };
  const num = n => n.toFixed(4);

  // Convert mm to PDF points (72pt per inch, 25.4mm per inch)
  const mm2pt = mm => mm * 72 / 25.4;
  const W = mm2pt(pageW_mm), H = mm2pt(pageH_mm);

  let body = '%PDF-1.4\n';
  const offsets = [];
  let objs = [];

  // Helper: add object
  const addObj = content => {
    const n = objs.length + 1;
    offsets.push(body.length);
    body += n + ' 0 obj\n' + content + '\nendobj\n';
    objs.push(n);
    return n;
  };

  // Each page needs: XObject image, content stream, page object
  const pageObjs = [];
  const catalogPages = [];

  for(let pi=0;pi<pages.length;pi++){
    const {imgData} = pages[pi];
    // Extract base64 from dataURL
    const b64 = imgData.split(',')[1];
    const rawBytes = atob(b64);
    const imgLen = rawBytes.length;

    // Determine image dimensions from JPEG header
    // Quick parse: find SOF0 marker (0xFF 0xC0)
    let imgW = 1, imgH = 1;
    for(let k=0;k<rawBytes.length-8;k++){
      if(rawBytes.charCodeAt(k)===0xFF && (rawBytes.charCodeAt(k+1)&0xFE)===0xC0){
        imgH = (rawBytes.charCodeAt(k+5)<<8)|rawBytes.charCodeAt(k+6);
        imgW = (rawBytes.charCodeAt(k+7)<<8)|rawBytes.charCodeAt(k+8);
        break;
      }
    }

    // Fit image to page with 10pt margin
    const margin = mm2pt(5);
    const maxW = W - margin*2, maxH = H - margin*2;
    const scale2 = Math.min(maxW/imgW, maxH/imgH);
    const drawW = imgW*scale2, drawH = imgH*scale2;
    const dx = margin + (maxW-drawW)/2, dy = margin + (maxH-drawH)/2;

    // Image XObject
    const imgObjN = addObj(`<< /Type /XObject /Subtype /Image\n/Width ${imgW} /Height ${imgH}\n/ColorSpace /DeviceRGB /BitsPerComponent 8\n/Filter /DCTDecode /Length ${imgLen}\n>>\nstream\n${rawBytes}endstream`);

    // Content stream
    const cs = `q\n${num(drawW)} 0 0 ${num(drawH)} ${num(dx)} ${num(H-dy-drawH)} cm\n/Im${pi} Do\nQ\n`;
    const csN = addObj(`<< /Length ${cs.length} >>\nstream\n${cs}endstream`);

    pageObjs.push({imgObjN, csN, imgKey: `Im${pi}`});
  }

  // Pages container
  const pagesRef = objs.length + 1; // will be this index
  const pageNodeNums = [];

  // First create the Pages object placeholder
  const pagesSlot = addObj(`<< /Type /Pages /Kids [] /Count ${pages.length} >>`);

  // Create each Page object
  for(let pi=0;pi<pages.length;pi++){
    const {imgObjN, csN, imgKey} = pageObjs[pi];
    const pageN = addObj(`<< /Type /Page /Parent ${pagesSlot} 0 R\n/MediaBox [0 0 ${num(W)} ${num(H)}]\n/Contents ${csN} 0 R\n/Resources << /XObject << /${imgKey} ${imgObjN} 0 R >> >>\n>>`);
    pageNodeNums.push(pageN);
  }

  // Patch Pages object with real kids list â€” replace its entry
  const kidsStr = pageNodeNums.map(n=>n+' 0 R').join(' ');
  body = body.replace(
    `<< /Type /Pages /Kids [] /Count ${pages.length} >>`,
    `<< /Type /Pages /Kids [${kidsStr}] /Count ${pages.length} >>`
  );

  // Catalog
  const catN = addObj(`<< /Type /Catalog /Pages ${pagesSlot} 0 R >>`);

  // Recompute offsets since we patched body
  // Actually we need to rebuild offsets from scratch
  const finalOffsets = [];
  let pos = 0;
  const re = /(\d+) 0 obj/g;
  let m;
  while((m=re.exec(body))!==null){
    const n = parseInt(m[1]);
    finalOffsets[n-1] = m.index;
  }

  // xref
  const xrefPos = body.length;
  const totalObjs = objs.length;
  body += `xref\n0 ${totalObjs+1}\n0000000000 65535 f \n`;
  for(let i=0;i<totalObjs;i++){
    body += String(finalOffsets[i]||0).padStart(10,'0') + ' 00000 n \n';
  }
  body += `trailer\n<< /Size ${totalObjs+1} /Root ${catN} 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;

  // Convert to Uint8Array
  const buf = new Uint8Array(body.length);
  for(let i=0;i<body.length;i++) buf[i]=body.charCodeAt(i)&0xff;
  return buf;
}

/* â”€â”€ Switch to a tab and capture it â”€â”€ */
async function switchAndCapture(tabId, tabLabel){
  // Switch tab
  document.querySelectorAll('.tab').forEach(b=>{
    if(b.textContent.trim().startsWith(tabLabel)){
      b.classList.add('act');
    } else {
      b.classList.remove('act');
    }
  });
  document.querySelectorAll('.tp').forEach(p=>p.classList.remove('act'));
  const tp=$('tp-'+tabId);
  if(tp) tp.classList.add('act');
  if(tabId==='shareholders') renderSH();

  // Wait for render + charts
  await new Promise(r=>setTimeout(r,400));

  const el=$('tp-'+tabId);
  if(!el) return null;

  // Use native canvas capture: draw each chart + overlay text
  const rect = el.getBoundingClientRect();
  const scale = 1.5;
  const cvs = document.createElement('canvas');
  cvs.width = Math.round(rect.width * scale);
  cvs.height = Math.round(Math.max(el.scrollHeight, rect.height) * scale);
  const ctx = cvs.getContext('2d');
  ctx.scale(scale, scale);
  ctx.fillStyle = '#F3F4F6';
  ctx.fillRect(0, 0, cvs.width/scale, cvs.height/scale);

  // Draw all chart canvases
  const charts = el.querySelectorAll('canvas');
  charts.forEach(ch => {
    const cr = ch.getBoundingClientRect();
    const pr = el.getBoundingClientRect();
    const x = cr.left - pr.left;
    const y = cr.top - pr.top;
    if(cr.width > 0 && cr.height > 0){
      ctx.drawImage(ch, x, y, cr.width, cr.height);
    }
  });

  // Draw KPI cards and tables using a simpler raster approach:
  // render the whole section as an in-page iframe screenshot
  return cvs;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF EXPORT â€” print-to-PDF via styled iframe
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function exportPDF(){
  expOverlay('Preparando PDF...');
  await new Promise(r=>setTimeout(r,80));

  const R=window._R||{};
  const p1=R.p1||getPrice(P.sc,P.fv1);
  const p2=R.p2||getPrice(P.sc,P.fv2);
  const now=new Date();
  const ds=now.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const ts=now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

  // Remember current tab
  const curTab=document.querySelector('.tab.act');
  const curTP=document.querySelector('.tp.act');

  // Build a full-page printable HTML document
  const tabs=[
    {id:'results',    btn:'Results Overview'},
    {id:'sensitivity',btn:'Sensitivity Analysis'},
    {id:'shareholders',btn:'Shareholder Detail'},
    {id:'methodology',btn:'Methodology & Checks'},
  ];

  const assumHeader=`
    <div class="pdfhdr">
      <div class="pdfhdr-title">BRN â€” MINORITY SHAREHOLDER BUYOUT DASHBOARD</div>
      <div class="pdfhdr-sub">Board of Directors &nbsp;Â·&nbsp; Confidential &nbsp;Â·&nbsp; Gerado: ${ds} ${ts}</div>
      <div class="pdfhdr-params">
        <span><b>CenÃ¡rio:</b> ${P.sc} â€” ${SC_DATA[P.sc].desc}</span>
        <span><b>Shares:</b> ${(SC_DATA[P.sc].shares/1e6).toFixed(2)}M</span>
        <span><b>Techmet Base:</b> ${fP(R.techmetBase||SC_DATA[P.sc].techmetBase)}</span>
        <span><b>FV1:</b> $${P.fv1}M â†’ $${p1.toFixed(4)}/sh</span>
        <span><b>FV2:</b> $${P.fv2}M â†’ $${p2.toFixed(4)}/sh</span>
        <span><b>Budget:</b> $${P.bud}M (${P.sp}% / ${100-P.sp}%)</span>
        <span><b>Caps:</b> $${P.c1}k / $${P.c2}k</span>
        <span><b>SH Saindo:</b> ${R.rem||0} de ${(R.pool||[]).length}</span>
        <span><b>Techmet ApÃ³s:</b> ${fP(R.tmPct||0)}</span>
        <span><b>DistribuÃ­do:</b> ${fM(R.td||0)}</span>
      </div>
    </div>`;

  // Capture each tab as a data URL
  const pages = [];
  for(let i=0;i<tabs.length;i++){
    const tab=tabs[i];
    sv('exp-msg', `Capturando ${tab.btn} (${i+1}/${tabs.length})...`);
    await new Promise(r=>setTimeout(r,30));

    // Switch tab
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('act', b.textContent.trim().startsWith(tab.btn)));
    document.querySelectorAll('.tp').forEach(p=>p.classList.remove('act'));
    const tp=$('tp-'+tab.id);
    if(tp) tp.classList.add('act');
    if(tab.id==='shareholders') renderSH();
    await new Promise(r=>setTimeout(r,380));

    // Get all chart canvases as data URLs
    const el=$('tp-'+tab.id);
    if(!el) continue;

    // Serialize the charts
    const chartData=[];
    el.querySelectorAll('canvas').forEach(ch=>{
      const r=ch.getBoundingClientRect();
      const pr=el.getBoundingClientRect();
      chartData.push({
        x:Math.round(r.left-pr.left), y:Math.round(r.top-pr.top),
        w:Math.round(r.width), h:Math.round(r.height),
        src:ch.toDataURL('image/png')
      });
    });

    pages.push({tabId:tab.id, label:tab.btn, chartData, elHTML:el.innerHTML});
  }

  // Restore tab
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('act'));
  document.querySelectorAll('.tp').forEach(p=>p.classList.remove('act'));
  if(curTab) curTab.classList.add('act');
  if(curTP) curTP.classList.add('act');

  sv('exp-msg','Montando PDF...');
  await new Promise(r=>setTimeout(r,30));

  // Build print HTML
  const chartImgTags = pages.map((pg,i)=>{
    const imgs=pg.chartData.map(c=>`<img src="${c.src}" style="position:absolute;left:${c.x}px;top:${c.y}px;width:${c.w}px;height:${c.h}px;" />`).join('');
    return `<div class="pdf-page">
      ${assumHeader}
      <div class="pdf-tab-label">${pg.label}</div>
      <div class="pdf-content" style="position:relative">
        ${pg.elHTML}
        <div class="chart-overlay" style="position:absolute;inset:0;pointer-events:none">${imgs}</div>
      </div>
    </div>`;
  }).join('');

  const printHTML=`<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;font-size:10px;background:#fff;color:#111}
    .pdf-page{width:277mm;min-height:190mm;padding:5mm;page-break-after:always;background:#fff}
    .pdf-page:last-child{page-break-after:avoid}
    .pdfhdr{background:#0F3D22;color:#fff;padding:6px 10px;border-radius:4px 4px 0 0;margin-bottom:2px}
    .pdfhdr-title{font-size:12px;font-weight:900;letter-spacing:.3px}
    .pdfhdr-sub{font-size:8px;opacity:.7;margin-top:1px}
    .pdfhdr-params{background:#1E6B3C;margin-top:2px;padding:4px 6px;border-radius:0 0 4px 4px;display:flex;flex-wrap:wrap;gap:3px 12px;font-size:8px;color:#fff}
    .pdfhdr-params b{font-weight:700}
    .pdf-tab-label{background:#EEF2FF;color:#3730A3;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;margin-bottom:4px;border-radius:3px}
    .pdf-content{overflow:hidden;max-height:155mm}
    /* Hide interactive elements */
    button,input,select,.tab-bar,.excl-bar,.sb,.hdr{display:none!important}
    /* Scale content to fit */
    .pdf-content>*{transform-origin:top left;transform:scale(0.72)}
    canvas{display:none!important}
    @media print{
      @page{size:A4 landscape;margin:8mm}
      .pdf-page{page-break-after:always;width:100%}
    }
  </style>
  </head><body>${chartImgTags}</body></html>`;

  // Open in new window and print
  const win=window.open('','_blank','width=1200,height=800');
  if(!win){
    expHide();
    alert('Pop-up bloqueado! Por favor permita pop-ups para este site e tente novamente.');
    return;
  }
  win.document.write(printHTML);
  win.document.close();
  win.focus();
  await new Promise(r=>setTimeout(r,600));
  win.print();
  expHide();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXCEL EXPORT â€” multi-sheet data
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportExcel(){
  expOverlay('Gerando Excel...');
  setTimeout(()=>{
    try{
      const R=window._R||{};
      const p1=R.p1||getPrice(P.sc,P.fv1);
      const p2=R.p2||getPrice(P.sc,P.fv2);
      const now=new Date();
      const ds=now.toLocaleDateString('pt-BR');
      const pool4=activePool();

      // Build HTML workbook â€” Excel opens multi-sheet HTML natively
      const sheetsHTML=[];

      /* â”€â”€ Sheet 1: Premissas & Resultados â”€â”€ */
      sheetsHTML.push(buildSheet('Premissas e Resultados',[
        ['BRN â€” MINORITY SHAREHOLDER BUYOUT DASHBOARD','',''],
        ['Gerado: '+ds+'  |  Confidencial â€” Board of Directors','',''],
        ['','',''],
        ['PREMISSAS','VALOR','NOTAS'],
        ['CenÃ¡rio Cap Table','Scenario '+P.sc, SC_DATA[P.sc].desc],
        ['Total AÃ§Ãµes BRN', SC_DATA[P.sc].shares, ''],
        ['Techmet Base %', fP(R.techmetBase||SC_DATA[P.sc].techmetBase), 'Antes do buyout'],
        ['FV 1Âº Tranche', '$'+P.fv1+'M', ''],
        ['PreÃ§o p1 (1Âº Tranche)', '$'+p1.toFixed(6)+'/sh', 'FV / Total AÃ§Ãµes'],
        ['FV 2Âº Tranche', '$'+P.fv2+'M', ''],
        ['PreÃ§o p2 (2Âº Tranche)', '$'+p2.toFixed(6)+'/sh', 'FV / Total AÃ§Ãµes'],
        ['Budget Total', '$'+P.bud.toFixed(1)+'M', ''],
        ['Split 1Âº Tranche', P.sp+'%', ''],
        ['Budget 1Âº Tranche', '$'+(P.bud*P.sp/100).toFixed(2)+'M', ''],
        ['Budget 2Âº Tranche', '$'+(P.bud*(100-P.sp)/100).toFixed(2)+'M', ''],
        ['Cap por SH â€” 1Âº Tranche', '$'+P.c1+'k', ''],
        ['Cap por SH â€” 2Âº Tranche', '$'+P.c2+'k', ''],
        ['AÃ§Ãµes Minority (total)', '86.022.601', 'Constante em todos os cenÃ¡rios'],
        ['','',''],
        ['RESULTADOS','VALOR',''],
        ['SH Saindo Completamente', R.rem||0, ''],
        ['SH Permanecendo', (R.pool||[]).length-(R.rem||0), ''],
        ['Total DistribuÃ­do', fM(R.td||0), ''],
        ['UtilizaÃ§Ã£o do Budget', Math.round((R.util||0)*100)+'%', ''],
        ['AÃ§Ãµes Recompradas', Math.round(R.bought||0).toLocaleString(), ''],
        ['Techmet ApÃ³s Buyout', fP(R.tmPct||0), ''],
        ['Ganho LÃ­quido Techmet', fP((R.tmPct||0)-(R.techmetBase||SC_DATA[P.sc].techmetBase)), ''],
        ['Score de EficiÃªncia', Math.round(R.score||0)+'%', ''],
      ]));

      /* â”€â”€ Sheet 2: Shareholder Detail â”€â”€ */
      const results=R.results||[];
      const shData=[
        ['DETALHE POR ACIONISTA â€” Sc.'+P.sc+' | p1=$'+p1.toFixed(4)+' | p2=$'+p2.toFixed(4)+' | Budget=$'+P.bud+'M | Caps:$'+P.c1+'k/$'+P.c2+'k'],
        [''],
        ['#','Acionista','Grupo','Status','AÃ§Ãµes Emitidas','CLN Opts','Total AÃ§Ãµes','Custo EmissÃ£o','Custo CLN','Custo Total','WAC EmissÃ£o','WAC CLN','WAC Blend','1Âº Rec.','2Âº Rec.','Total Rec.','Vendidas 1Âº','Vendidas 2Âº','Total Vendidas','Restantes Iss.','Restantes CLN','Total Restante','G&L/aÃ§Ã£o','G&L Total'],
        ...results.map((r,i)=>[
          i+1,r.n,r.gr==='D'?'Contestando':'Outro',r.exits?'SAI':'FICA',
          r.iss,r.cln,r.tot,
          '$'+Math.round(r.issCost).toLocaleString(),'$'+Math.round(r.clnCost).toLocaleString(),'$'+Math.round(r.totalCost).toLocaleString(),
          '$'+r.wacIss.toFixed(4),'$'+r.wacCln.toFixed(4),'$'+r.wacBlend.toFixed(4),
          '$'+Math.round(r.r1).toLocaleString(),'$'+Math.round(r.r2).toLocaleString(),'$'+Math.round(r.totalRecv).toLocaleString(),
          Math.round(r.sold1).toLocaleString(),Math.round(r.sold2).toLocaleString(),Math.round(r.totalSold).toLocaleString(),
          Math.round(r.issAfter).toLocaleString(),Math.round(r.clnAfter).toLocaleString(),Math.round(r.totalAfter).toLocaleString(),
          '$'+r.plPerSh.toFixed(4),'$'+Math.round(r.plTotal).toLocaleString()
        ]),
        ['','TOTAL','','',
          results.reduce((a,r)=>a+r.iss,0).toLocaleString(),results.reduce((a,r)=>a+r.cln,0).toLocaleString(),results.reduce((a,r)=>a+r.tot,0).toLocaleString(),
          '$'+Math.round(results.reduce((a,r)=>a+r.issCost,0)).toLocaleString(),'','$'+Math.round(results.reduce((a,r)=>a+r.totalCost,0)).toLocaleString(),
          '','','',
          '$'+Math.round(results.reduce((a,r)=>a+r.r1,0)).toLocaleString(),'$'+Math.round(results.reduce((a,r)=>a+r.r2,0)).toLocaleString(),'$'+Math.round(R.td||0).toLocaleString(),
          '','',Math.round(R.bought||0).toLocaleString(),'','','','',
          '$'+Math.round(results.reduce((a,r)=>a+r.plTotal,0)).toLocaleString()],
      ];
      sheetsHTML.push(buildSheet('Detalhe por Acionista', shData));

      /* â”€â”€ Sheet 3: Matriz de PreÃ§os â”€â”€ */
      const priceData=[
        ['MATRIZ DE PREÃ‡OS â€” Valuation Ã— CenÃ¡rio'],
        ['FÃ³rmula: PreÃ§o = FV / Total AÃ§Ãµes BRN  |  Gerado: '+ds],
        [''],
        ['Valuation (FV)','Sc.I (192.8M)','Sc.II (483.4M)','Sc.III (575.1M)','Sc.IV (644.2M)','Sc.V (665.6M)','SH Saindo','Budget%'],
        ...FV_VALS.map(fv=>{
          const prices=FV_PRICES[fv];
          const si=SC_KEYS.indexOf(P.sc);
          const mr=runModel(pool4,P.bud,P.sp,P.c1,P.c2,prices[si],getPrice(P.sc,P.fv2),P.sc);
          return['$'+fv+'M',...prices.map(p=>'$'+p.toFixed(4)),mr.rem,Math.round(mr.td/(P.bud*1e6)*100)+'%'];
        }),
        [''],['Techmet Base % por CenÃ¡rio:'],
        SC_KEYS.map(sc=>'Sc.'+sc),
        SC_KEYS.map(sc=>fP(SC_DATA[sc].techmetBase)),
      ];
      sheetsHTML.push(buildSheet('Matriz de PreÃ§os', priceData));

      /* â”€â”€ Sheet 4: Sensibilidade â”€â”€ */
      const sensData=[
        ['ANÃLISE DE SENSIBILIDADE â€” Budget & Caps'],
        ['CenÃ¡rio: Sc.'+P.sc+' | p1=$'+p1.toFixed(4)+' | p2=$'+p2.toFixed(4)+' | Split='+P.sp+'%'],
        [''],
        ['BUDGET SWEEP (Caps: $'+P.c1+'k / $'+P.c2+'k)'],
        ['Budget','SH Saindo','Budget Usado','NÃ£o Gasto'],
        ...[0.5,1,1.5,2,3,4,5,6,7,8,10].map(b=>{
          const mr=runModel(pool4,b,P.sp,P.c1,P.c2,p1,p2,P.sc);
          return['$'+b+'M',mr.rem,Math.round(mr.td/(b*1e6)*100)+'%','$'+Math.round(Math.max(0,b*1e6-mr.td)/1000)+'k'+(b===P.bud?' â† ATUAL':'')];
        }),
        [''],['SPLIT SWEEP (Budget: $'+P.bud+'M)'],
        ['Split 1Âº %','SH Saindo','Budget Usado',''],
        ...[5,10,20,30,40,50,60,70,75,80,85,90,95].map(sp=>{
          const mr=runModel(pool4,P.bud,sp,P.c1,P.c2,p1,p2,P.sc);
          return[sp+'%',mr.rem,Math.round(mr.td/(P.bud*1e6)*100)+'%',sp===P.sp?'â† ATUAL':''];
        }),
        [''],['GRID DE CAPS â€” SH SAINDO (2Âº Cap â†“ / 1Âº Cap â†’)'],
        [''].concat(HC1.map(c=>'$'+c+'k')),
        ...HC2.map(c2=>{
          const row=['$'+c2+'k'];
          HC1.forEach(c1=>{ const mr=runModel(pool4,P.bud,P.sp,c1,c2,p1,p2,P.sc); row.push(mr.rem+(c1===P.c1&&c2===P.c2?' â—„':''));});
          return row;
        }),
      ];
      sheetsHTML.push(buildSheet('Sensibilidade', sensData));

      /* â”€â”€ Sheet 5: Cap Table CenÃ¡rios â”€â”€ */
      const ctData=[
        ['CENÃRIOS DE CAP TABLE â€” BRN'],
        ['Gerado: '+ds],[''],
        ['CenÃ¡rio','DescriÃ§Ã£o','Total AÃ§Ãµes','AÃ§Ãµes Minority','Techmet Base%','p1 (FV=$'+P.fv1+'M)','p2 (FV=$'+P.fv2+'M)'],
        ...SC_KEYS.map(sc=>{
          const d=SC_DATA[sc];
          return['Sc.'+sc,d.desc,d.shares.toLocaleString(),'86.022.601',fP(d.techmetBase),'$'+getPrice(sc,P.fv1).toFixed(6),'$'+getPrice(sc,P.fv2).toFixed(6)];
        }),
        [''],
        ['Notas:'],
        ['PreÃ§o/aÃ§Ã£o = Valuation (FV) Ã· Total AÃ§Ãµes BRN para o cenÃ¡rio selecionado'],
        ['Techmet Base% = (Total AÃ§Ãµes âˆ’ Minority Total) Ã· Total AÃ§Ãµes'],
      ];
      sheetsHTML.push(buildSheet('Cap Table CenÃ¡rios', ctData));

      // Generate multi-sheet Excel HTML file
      const xlsHTML=`<html xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:x="urn:schemas-microsoft-com:office:excel"
        xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>
        ${sheetsHTML.map((s,i)=>`<x:ExcelWorksheet><x:Name>${s.name}</x:Name><x:WorksheetSource HRef="sheet${i}"/></x:ExcelWorksheet>`).join('')}
      </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
      <style>
        td{font-family:Arial;font-size:10pt;border:1px solid #D1D5DB;padding:3px 6px;vertical-align:top}
        .hdr{background:#0F3D22;color:#fff;font-weight:bold;font-size:12pt}
        .subhdr{background:#1E6B3C;color:#fff;font-weight:bold}
        .col{background:#374151;color:#fff;font-weight:bold;font-size:9pt}
        .tot{background:#E5F2EA;font-weight:bold}
        .hi{background:#FFF8E7}
        tr:nth-child(even) td{background:#F9FAFB}
        .hdr td,.subhdr td,.col td,.tot td{background:inherit!important}
      </style></head><body>
      ${sheetsHTML.map((s,i)=>`<table id="sheet${i}" style="display:block">${s.html}</table><br style="page-break-before:always">`).join('')}
      </body></html>`;

      const blob=new Blob([xlsHTML],{type:'application/vnd.ms-excel;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`BRN_Buyout_Sc${P.sc}_FV${P.fv1}M_${ds.replace(/\//g,'-')}.xls`;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url),2000);
    } catch(e){
      console.error(e);
      alert('Erro ao gerar Excel: '+e.message);
    }
    expHide();
  }, 100);
}

function buildSheet(name, rows){
  const html=rows.map((row,ri)=>{
    if(!Array.isArray(row)||row.length===0) return '<tr><td colspan="30" style="border:none;height:8px"></td></tr>';
    const isTitle=ri===0;
    const isHdr=row.some(c=>typeof c==='string'&&(c.includes('PREMISSAS')||c.includes('RESULTADO')||c.includes('DETALHE')||c.includes('MATRIZ')||c.includes('ANÃLISE')||c.includes('CENÃRIO')||c.includes('BRN â€”')||c.includes('ACIONISTA')||c.includes('SWEEP')||c.includes('GRID')||c.includes('Notas')));
    const isCol=row.every(c=>typeof c==='string'&&c.length>0)&&ri>2&&!isHdr;
    const cls=isTitle?'hdr':isHdr?'subhdr':isCol&&row[0]==='#'?'col':'';
    return `<tr class="${cls}">${row.map(c=>`<td>${c===null||c===undefined?'':c}</td>`).join('')}</tr>`;
  }).join('');
  return {name, html};
}

/* â”€â”€ INIT â”€â”€ */
$('hdr-date').textContent=new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}).toUpperCase();
Chart.defaults.font.family='Open Sans'; Chart.defaults.color='#6B7280';
syncSliders();
update();
</script>
</body>
</html>
